<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRUDEV II MSME Support Portal</title>
    <meta name="description" content="Business Growth Expert reporting and MSME management portal for PRUDEV II">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gizblue: {
                            50: '#e1f0f7',
                            100: '#b4d9eb',
                            200: '#82bede',
                            300: '#4da1d0',
                            400: '#238ac5',
                            500: '#00609b',
                            600: '#00588f',
                            700: '#004d7e',
                            800: '#00436d',
                            900: '#003153',
                        },
                        gizgreen: {
                            50: '#f1f8e6',
                            100: '#dcefc2',
                            200: '#c5e499',
                            300: '#add970',
                            400: '#99cf4f',
                            500: '#62a127',
                            600: '#589123',
                            700: '#4c7d1e',
                            800: '#406a19',
                            900: '#2e4c12',
                        },
                        gopared: {
                            50: '#fce6e7',
                            100: '#f8c2c4',
                            200: '#f4999d',
                            300: '#f07075',
                            400: '#ec4d53',
                            500: '#e30613',
                            600: '#d10511',
                            700: '#ba050f',
                            800: '#a3040d',
                            900: '#8a030b',
                        }
                    }
                }
            }
        }
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-serif {
            font-family: 'Playfair Display', serif;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white !important;
            }

            .print-area {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                width: 100% !important;
                margin: 0 !important;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .animate-shake {
            animation: shake 0.2s ease-in-out 0s 2;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-gizblue-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // SVG Icon Components
        const Shield = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></svg>;
        const Lock = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></svg>;
        const Users = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>;
        const UserCheck = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><polyline points="16 11 18 13 22 9" /></svg>;
        const Mail = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" /><polyline points="22,6 12,13 2,6" /></svg>;
        const ClipboardCopy = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /></svg>;
        const Check = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12" /></svg>;
        const FileText = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></svg>;
        const Printer = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></svg>;
        const Trash2 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></svg>;
        const ChevronRight = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6" /></svg>;
        const AlertCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></svg>;
        const Database = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></svg>;
        const LinkIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></svg>;
        const Plus = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>;
        const Edit = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>;
        const Edit2 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>;
        const Calendar = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></svg>;
        const ClipboardList = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></svg>;
        // Added Download and Upload icons as they are used in CSV buttons
        const Download = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>;
        const Upload = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></svg>;
        const X = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const Building = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2" /><path d="M9 22v-4h6v4" /><path d="M8 6h.01" /><path d="M16 6h.01" /><path d="M12 6h.01" /><path d="M12 10h.01" /><path d="M12 14h.01" /><path d="M16 10h.01" /><path d="M16 14h.01" /><path d="M8 10h.01" /><path d="M8 14h.01" /></svg>;
        const Layout = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><line x1="3" y1="9" x2="21" y2="9" /><line x1="9" y1="21" x2="9" y2="9" /></svg>;
        const PieChart = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></svg>;
        const BarChart = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10" /><line x1="12" y1="20" x2="12" y2="4" /><line x1="6" y1="20" x2="6" y2="14" /></svg>;
        const Trophy = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22h10c0-1.76-.85-3.25-2.03-3.79-.5-.23-.97-.66-.97-1.21v-2.34c0-2.58 4-3.66 4-6.66V4H6v4c0 3 4 4.08 4 6.66z" /></svg>;
        const Search = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></svg>;
        const Save = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></svg>;
        const ChevronDown = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const Briefcase = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></svg>;
        const Star = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></svg>;
        const MapPin = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
        const MapIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>;
        const LogOut = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></svg>;

        // Dashboard Quick Links (re-used across the app)
        const QUICK_LINKS = {
            BGEMasterSheet: "https://docs.google.com/spreadsheets/d/1A6OHAXqiKM5aZBWphhMofEImo7UkNI3i/edit?usp=sharing&ouid=112327364399355083547&rtpof=true&sd=true",
            msmeCohort1Sheet: "https://docs.google.com/spreadsheets/d/1SVO6vWr2Dn0CE02vxnlGO8daNiggCyI2/edit?gid=1223213683#gid=1223213683",
            msmeCohort2Sheet: "https://docs.google.com/spreadsheets/d/1glDn1U8fwo-UJCo5akk4gD1d25F45klg/edit?gid=1212040973",
        };

        const ADMIN_PASSCODE = "2026";

        const SEED_BGES = [];
        const SEED_MSMES = [];
        const SEED_ASSIGNMENTS = [];

        // LocalStorage helpers
        const storage = {
            get: (key, defaultValue = []) => {
                try {
                    const item = localStorage.getItem(key);
                    if (!item || item === 'null') return defaultValue;
                    const parsed = JSON.parse(item);
                    return Array.isArray(parsed) ? parsed : defaultValue;
                } catch {
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.error('Storage error:', e);
                }
            }
        };

        // Helper components (moved to top for hoisting stability)
        const StatCard = ({ label, value, icon: Icon, color }) => {
            const colors = {
                blue: 'bg-gizblue-50 text-gizblue-600',
                green: 'bg-gizgreen-50 text-gizgreen-600',
                red: 'bg-gopared-50 text-gopared-600',
                gizblue: 'bg-gizblue-600 text-white'
            };
            return (
                <div className={`${color === 'gizblue' ? colors.gizblue : 'bg-white'} p-6 rounded-3xl border border-gray-100 shadow-sm hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1`}>
                    <div className="flex items-center justify-between mb-4">
                        <div className={`p-3 rounded-2xl ${color === 'gizblue' ? 'bg-white/20' : (colors[color] || colors.blue)}`}>
                            <Icon className="w-6 h-6" />
                        </div>
                    </div>
                    <div className="text-3xl font-black mb-1">{value}</div>
                    <div className={`text-xs font-bold uppercase tracking-wider ${color === 'gizblue' ? 'text-gizblue-100' : 'text-gray-400'}`}>{label}</div>
                </div>
            );
        };

        const ExternalLink = ({ href, label, icon: Icon }) => (
            <a
                href={href}
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center justify-between p-4 bg-white rounded-2xl border border-gray-100 hover:border-gizblue-300 hover:shadow-md transition-all group"
            >
                <div className="flex items-center space-x-3">
                    <div className="p-2 bg-gray-50 rounded-lg group-hover:bg-gizblue-50 group-hover:text-gizblue-600 transition-colors">
                        <Icon className="w-5 h-5" />
                    </div>
                    <span className="text-sm font-semibold text-gray-700">{label}</span>
                </div>
                <LinkIcon className="w-4 h-4 text-gray-300 group-hover:text-gizblue-600" />
            </a>
        );

        const normalizeGoogleSheetsUrlToCsv = (url) => {
            if (!url) return url;
            try {
                const u = new URL(url);
                const isGoogleSheets = u.hostname.includes('docs.google.com') && u.pathname.includes('/spreadsheets/');
                if (!isGoogleSheets) return url;

                // Already an export link or published CSV output
                if (u.pathname.includes('/export') || u.searchParams.get('output') === 'csv') return url;

                const match = u.pathname.match(/\/spreadsheets\/d\/([^/]+)/);
                const sheetId = match?.[1];
                const gid = u.searchParams.get('gid');
                if (!sheetId) return url;

                const exportUrl = new URL(`https://docs.google.com/spreadsheets/d/${sheetId}/export`);
                exportUrl.searchParams.set('format', 'csv');
                if (gid) exportUrl.searchParams.set('gid', gid);
                return exportUrl.toString();
            } catch {
                return url;
            }
        };

        const parseCsvTextToObjects = (text) => {
            if (!text) return [];
            // Remove Byte Order Mark (BOM) if present
            const cleanText = text.replace(/^\uFEFF/, '');
            const lines = cleanText.split(/\r?\n/).filter(line => line.trim());
            if (lines.length < 2) return [];

            const rawHeaders = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const normalize = (str) => (str || '').toLowerCase().replace(/[^a-z0-9]/g, '');

            return lines.slice(1).map(line => {
                const values = [];
                let cur = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) {
                        values.push(cur.trim().replace(/^"|"$/g, '').replace(/"{2}/g, '"'));
                        cur = '';
                    } else cur += char;
                }
                values.push(cur.trim().replace(/^"|"$/g, '').replace(/"{2}/g, '"'));

                const obj = {};
                rawHeaders.forEach((header, i) => {
                    const key = normalize(header);
                    obj[key] = values[i] || '';
                    obj[header] = values[i] || '';
                });
                return obj;
            });
        };

        const SheetSyncButton = ({ type, onImport, urlStorageKey, defaultUrl }) => {
            const handleSync = async () => {
                try {
                    const existing = localStorage.getItem(urlStorageKey) || defaultUrl || '';
                    const input = prompt(
                        `Paste the Google Sheet link (or a published CSV link) for ${type}.\n\nTip: you can paste a normal "docs.google.com/spreadsheets/.../edit?gid=..." link â€” it will be converted to CSV automatically.`,
                        existing
                    );
                    if (!input) return;
                    const csvUrl = normalizeGoogleSheetsUrlToCsv(input.trim());
                    localStorage.setItem(urlStorageKey, csvUrl);

                    const res = await fetch(csvUrl, { cache: 'no-store' });
                    if (!res.ok) throw new Error(`Fetch failed (${res.status})`);
                    const text = await res.text();
                    const data = parseCsvTextToObjects(text);
                    if (!data.length) {
                        alert('No rows found. If this is a Google Sheet, ensure it is accessible and/or published, and that you pasted the correct sheet tab (gid).');
                        return;
                    }

                    onImport(data);
                } catch (err) {
                    console.error('Sheet sync error:', err);
                    alert('Failed to sync from Google Sheet. Ensure the sheet is accessible and the link points to a CSV export/published URL.');
                }
            };

            return (
                <button
                    onClick={handleSync}
                    className="flex items-center space-x-2 bg-white border border-gray-200 text-gray-700 px-3 sm:px-4 py-2 rounded-2xl text-sm font-bold hover:bg-gray-50 transition-all shadow-sm whitespace-nowrap"
                    title="Sync data from Google Sheets (CSV export)"
                >
                    <LinkIcon className="w-4 h-4 text-gizblue-600" />
                    <span>Sync {type}</span>
                </button>
            );
        };

        const CSVImportButton = ({ onImport, type }) => (
            <div className="relative group">
                <input
                    type="file"
                    accept=".csv"
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                    onChange={(e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                try {
                                    const text = event.target.result;
                                    const data = parseCsvTextToObjects(text);
                                    if (!data.length) {
                                        alert('The CSV file appears to be empty or missing data rows.');
                                        return;
                                    }

                                    onImport(data);
                                    e.target.value = '';
                                } catch (err) {
                                    console.error('Import error:', err);
                                    alert('Failed to parse CSV. Please ensure it is a valid comma-separated file.');
                                }
                            };
                            reader.readAsText(file);
                        }
                    }}
                />
                <button className="flex items-center space-x-2 bg-gizblue-600 text-white px-3 sm:px-4 py-2 rounded-2xl text-sm font-bold hover:bg-gizblue-700 transition-all shadow-lg shadow-gizblue-100 whitespace-nowrap">
                    <Upload className="w-4 h-4" />
                    <span>Import {type} CSV</span>
                </button>
            </div>
        );

        const CSVExportButton = ({ data, filename, type }) => {
            const handleExport = () => {
                if (!data || data.length === 0) {
                    alert('No data available to export.');
                    return;
                }

                const headers = Object.keys(data[0]);
                const csvRows = [];
                csvRows.push(headers.join(','));

                for (const row of data) {
                    const values = headers.map(header => {
                        const val = row[header] === null || row[header] === undefined ? '' : row[header];
                        const escaped = ('' + val).replace(/"/g, '""');
                        return `"${escaped}"`;
                    });
                    csvRows.push(values.join(','));
                }

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <button
                    onClick={handleExport}
                    className="flex items-center space-x-2 bg-white border border-gray-200 text-gray-700 px-3 sm:px-4 py-2 rounded-2xl text-sm font-bold hover:bg-gray-50 transition-all shadow-sm whitespace-nowrap"
                >
                    <Download className="w-4 h-4 text-gizblue-600" />
                    <span>Export {type} CSV</span>
                </button>
            );
        };
        const SortButton = ({ label, active, direction, onClick }) => (
            <button
                onClick={(e) => {
                    e.preventDefault();
                    onClick();
                }}
                className={`flex items-center space-x-1 hover:text-gizblue-600 transition-colors uppercase tracking-wider ${active ? 'text-gizblue-600 font-bold' : ''}`}
            >
                <span>{label}</span>
                <div className="flex flex-col">
                    <ChevronDown className={`w-3 h-3 transition-transform duration-300 ${active && direction === 'asc' ? 'rotate-180' : 'opacity-30'}`} />
                </div>
            </button>
        );


        const SidebarItem = ({ id, activeTab, setActiveTab, label, icon: Icon }) => (
            <button
                onClick={() => setActiveTab(id)}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all ${activeTab === id
                    ? 'bg-gizblue-600 text-white shadow-lg'
                    : 'text-gray-500 hover:bg-gizblue-50 hover:text-gizblue-600'
                    }`}
            >
                <Icon className="w-5 h-5" />
                <span className="font-medium">{label}</span>
            </button>
        );

        const PairingForm = ({ bges, msmes, assignments, onPair }) => {
            const [bge, setBge] = useState('');
            const [msme, setMsme] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (bge && msme) {
                    onPair(bge, msme);
                    setBge('');
                    setMsme('');
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Select Expert</label>
                        <select
                            value={bge}
                            onChange={(e) => setBge(e.target.value)}
                            className="w-full bg-gray-50 border-none rounded-2xl px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-gizblue-500"
                        >
                            <option value="">-- Choose BGE --</option>
                            {bges.map(b => <option key={b.id} value={b.id}>{b.name} ({b.code})</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Select Business</label>
                        <select
                            value={msme}
                            onChange={(e) => setMsme(e.target.value)}
                            className="w-full bg-gray-50 border-none rounded-2xl px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-gizblue-500"
                        >
                            <option value="">-- Choose MSME --</option>
                            {msmes.filter(m => !assignments.some(a => a.msmeId === m.id)).map(m => (
                                <option key={m.id} value={m.id}>{m.name}</option>
                            ))}
                        </select>
                    </div>
                    <button
                        type="submit"
                        className="w-full bg-gizblue-600 text-white py-3 rounded-2xl font-bold shadow-lg shadow-gizblue-100 hover:bg-gizblue-700 transition-all active:scale-[0.98]"
                    >
                        Establish Assignment
                    </button>
                </form>
            );
        };

        const App = () => {
            const [view, setView] = useState('report');
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(() => localStorage.getItem('prudev_admin_auth') === 'true');
            const [passcode, setPasscode] = useState('');
            const [loginError, setLoginError] = useState(false);
            const [bges, setBges] = useState([]);
            const [msmes, setMsmes] = useState([]);
            const [assignments, setAssignments] = useState([]);
            const [reports, setReports] = useState([]);
            const [groups, setGroups] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editingBge, setEditingBge] = useState(null);
            const [editingMsme, setEditingMsme] = useState(null);
            const [activeGroupLeader, setActiveGroupLeader] = useState(null); // For Team Leader Login

            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                location: '',
                latitude: '',
                longitude: '',
                gpsCaptured: false,
                businessName: '',
                bgeName: '',
                bgeCode: '',
                objectives: '',
                activities: '',
                swot: '',
                leadership: '',
                gender: '',
                waste: '',
                climate: '',
                bdsActions: '',
            });

            // Initialize data from localStorage
            useEffect(() => {
                const storedBges = storage.get('prudev_bges', SEED_BGES).map(b => ({
                    ...b,
                    name: b.name || 'Unnamed BGE',
                    location: b.location || 'Unknown',
                    code: b.code || 'BGE-?'
                }));
                const storedMsmes = storage.get('prudev_msmes', SEED_MSMES).map(m => ({
                    ...m,
                    name: m.name || 'Unnamed MSME',
                    location: m.location || 'Unknown',
                    cohort: m.cohort || '1'
                }));
                const storedAssignments = storage.get('prudev_assignments', []);
                const storedReports = storage.get('prudev_reports', []);
                const storedGroups = storage.get('prudev_groups', []);

                setBges(storedBges);
                setMsmes(storedMsmes);
                setAssignments(storedAssignments);
                setReports(storedReports);
                setGroups(storedGroups);
                setLoading(false);

                // Check URL hash for BGE name
                const hash = decodeURIComponent(window.location.hash.substring(1));
                if (hash) {
                    const found = storedBges.find(b => b.name === hash);
                    if (found) {
                        updateField('bgeName', found.name);
                        updateField('bgeCode', found.code);
                    }
                }
            }, []);

            // Save to localStorage whenever data changes
            useEffect(() => {
                if (!loading) {
                    storage.set('prudev_bges', bges);
                    storage.set('prudev_msmes', msmes);
                    storage.set('prudev_assignments', assignments);
                    storage.set('prudev_reports', reports);
                    storage.set('prudev_groups', groups);
                }
            }, [bges, msmes, assignments, reports, groups, loading]);

            const updateField = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));

                // Auto-populate BGE code when name is selected
                if (field === 'bgeName') {
                    const bge = bges.find(b => b.name === value);
                    if (bge) {
                        setFormData(prev => ({ ...prev, bgeCode: bge.code }));
                    }
                }
            };

            const [teamLoginError, setTeamLoginError] = useState(false);

            const handleTeamLeaderLogin = (groupId, password) => {
                const group = groups.find(g => g.id === groupId);
                if (group && group.password === password) {
                    setActiveGroupLeader(group.id);
                    localStorage.setItem('prudev_team_auth', group.id);
                    setTeamLoginError(false);
                    setView('team-dashboard');
                } else {
                    setTeamLoginError(true);
                    setTimeout(() => setTeamLoginError(false), 500);
                }
            };

            const handleAdminLogin = (e) => {
                e.preventDefault();
                if (passcode === ADMIN_PASSCODE) {
                    setIsAdminAuthenticated(true);
                    localStorage.setItem('prudev_admin_auth', 'true');
                    setLoginError(false);
                    setView('admin');
                } else {
                    setLoginError(true);
                    setTimeout(() => setLoginError(false), 500);
                }
            };

            // Check for existing sessions on load
            useEffect(() => {
                const adminAuth = localStorage.getItem('prudev_admin_auth');
                if (adminAuth === 'true') setIsAdminAuthenticated(true);

                const teamAuth = localStorage.getItem('prudev_team_auth');
                if (teamAuth && groups.length > 0) {
                    // Verify group still exists
                    if (groups.some(g => g.id === teamAuth)) {
                        setActiveGroupLeader(teamAuth);
                    } else {
                        localStorage.removeItem('prudev_team_auth');
                    }
                }
            }, [groups]);

            const handlePrint = () => {
                window.print();
            };

            // BGE Management
            const addBge = (bge) => {
                const newBge = { ...bge, id: 'b' + Date.now() };
                setBges(prev => [...prev, newBge]);
            };

            const deleteBge = (id) => {
                if (confirm('Are you sure you want to delete this BGE?')) {
                    setBges(prev => prev.filter(b => b.id !== id));
                    setAssignments(prev => prev.filter(a => a.bgeId !== id));
                }
            };

            // MSME Management
            const addMsme = (msme) => {
                const newMsme = { ...msme, id: 'm' + Date.now() };
                setMsmes(prev => [...prev, newMsme]);
            };

            const deleteMsme = (id) => {
                if (confirm('Are you sure you want to delete this MSME?')) {
                    setMsmes(prev => prev.filter(m => m.id !== id));
                    setAssignments(prev => prev.filter(a => a.msmeId !== id));
                }
            };

            const clearAllMsmes = () => {
                if (confirm('CAUTION: This will delete ALL MSMEs and their assignments. This cannot be undone. Proceed?')) {
                    if (confirm('FINAL WARNING: Are you absolutely sure you want to erase all data?')) {
                        setMsmes([]);
                        setAssignments([]);
                        alert('All MSME data has been cleared.');
                    }
                }
            };

            // Assignment Management
            const addAssignment = (bgeId, msmeId) => {
                // Prevent duplicate assignment for the same MSME
                if (assignments.some(a => a.msmeId === msmeId)) {
                    alert('This business is already assigned to an expert.');
                    return;
                }

                const bge = bges.find(b => b.id === bgeId);
                const msme = msmes.find(m => m.id === msmeId);
                if (bge && msme) {
                    const newAssignment = {
                        id: 'a' + Date.now(),
                        bgeId,
                        msmeId,
                        bgeName: bge.name,
                        msmeName: msme.name,
                        date: new Date().toISOString().split('T')[0]
                    };
                    setAssignments(prev => [...prev, newAssignment]);
                }
            };

            const deleteAssignment = (id) => {
                if (confirm('Are you sure you want to delete this assignment?')) {
                    setAssignments(prev => prev.filter(a => a.id !== id));
                }
            };

            const getBgeAssignments = (bgeId) => assignments.filter(a => a.bgeId === bgeId);

            // Report Management
            const addReport = (reportData) => {
                const newReport = {
                    ...reportData,
                    id: 'r' + Date.now(),
                    timestamp: new Date().toISOString()
                };
                setReports(prev => [...prev, newReport]);
                alert('Report saved successfully to archive!');
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <Database className="w-16 h-16 mx-auto mb-4 text-gizblue-600 animate-pulse" />
                            <p className="text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen">
                    {/* Navigation */}
                    <nav className="no-print bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center space-x-3">
                                    <img
                                        src="assets/gopa_afc_logo.png"
                                        alt="GOPA AFC Logo"
                                        className="h-12 object-contain"
                                    />
                                    <div>
                                        <h1 className="text-xl font-bold text-gray-900">PRUDEV II</h1>
                                        <p className="text-xs text-gray-500">MSME Support Portal</p>
                                    </div>
                                </div>
                                <div className="flex space-x-1 sm:space-x-2">
                                    <button
                                        onClick={() => setView('report')}
                                        className={`flex items-center px-3 sm:px-4 py-2 rounded-2xl font-bold text-xs transition-all ${view === 'report'
                                            ? 'bg-gizblue-600 text-white shadow-md'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                    >
                                        <FileText className="w-3.5 h-3.5 sm:mr-2" />
                                        <span className="hidden sm:inline">Report Form</span>
                                        <span className="sm:hidden ml-1">Form</span>
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (!isAdminAuthenticated) {
                                                setView('login');
                                            } else {
                                                setView('admin');
                                            }
                                        }}
                                        className={`flex items-center px-3 sm:px-4 py-2 rounded-2xl font-bold text-xs transition-all ${view === 'admin' || view === 'login'
                                            ? 'bg-gizblue-600 text-white shadow-md'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                    >
                                        <Lock className="w-3.5 h-3.5 sm:mr-2" />
                                        <span className="hidden sm:inline">Portal Admin/Team</span>
                                        <span className="sm:hidden ml-1">Login</span>
                                    </button>
                                    {(isAdminAuthenticated || activeGroupLeader) && (
                                        <button
                                            onClick={() => {
                                                if (confirm('Are you sure you want to logout?')) {
                                                    setIsAdminAuthenticated(false);
                                                    localStorage.removeItem('prudev_admin_auth');
                                                    setActiveGroupLeader(null);
                                                    localStorage.removeItem('prudev_team_auth');
                                                    setView('report');
                                                }
                                            }}
                                            className="p-2 rounded-2xl text-gray-400 hover:text-gopared-600 hover:bg-gopared-50 transition-all"
                                            title="Logout"
                                        >
                                            <LogOut className="w-5 h-5" />
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {view === 'login' && !isAdminAuthenticated && !activeGroupLeader && (
                            <LoginScreen
                                passcode={passcode}
                                setPasscode={setPasscode}
                                handleAdminLogin={handleAdminLogin}
                                loginError={loginError}
                                groups={groups}
                                handleTeamLeaderLogin={handleTeamLeaderLogin}
                                teamLoginError={teamLoginError}
                            />
                        )}

                        {view === 'admin' && isAdminAuthenticated && (
                            <AdminPanel
                                bges={bges}
                                setBges={setBges}
                                msmes={msmes}
                                setMsmes={setMsmes}
                                assignments={assignments}
                                setAssignments={setAssignments}
                                reports={reports}
                                setReports={setReports}
                                addBge={addBge}
                                deleteBge={deleteBge}
                                addMsme={addMsme}
                                deleteMsme={deleteMsme}
                                clearAllMsmes={clearAllMsmes}
                                addAssignment={addAssignment}
                                deleteAssignment={deleteAssignment}
                                editingBge={editingBge}
                                setEditingBge={setEditingBge}
                                editingMsme={editingMsme}
                                setEditingMsme={setEditingMsme}
                                getBgeAssignments={getBgeAssignments}
                                groups={groups}
                                setGroups={setGroups}
                            />
                        )}

                        {view === 'team-dashboard' && activeGroupLeader && (
                            <TeamLeaderDashboard
                                group={groups.find(g => g.id === activeGroupLeader)}
                                leader={bges.find(b => b.id === groups.find(g => g.id === activeGroupLeader)?.leaderId) || { name: 'Unknown Leader' }}
                                bges={bges}
                                msmes={msmes}
                                assignments={assignments}
                                reports={reports}
                            />
                        )}

                        {view === 'report' && (
                            <ReportForm
                                formData={formData}
                                updateField={updateField}
                                handlePrint={handlePrint}
                                addReport={addReport}
                                bges={bges}
                                msmes={msmes}
                                assignments={assignments}
                                reports={reports}
                            />
                        )}
                    </main>
                </div>
            );
        };

        const LoginScreen = ({
            passcode, setPasscode, handleAdminLogin, loginError,
            groups, handleTeamLeaderLogin, teamLoginError
        }) => {
            const [mode, setMode] = useState('admin'); // 'admin' or 'team'
            const [selectedGroupId, setSelectedGroupId] = useState('');
            const [teamPassword, setTeamPassword] = useState('');

            const onTeamSubmit = (e) => {
                e.preventDefault();
                handleTeamLeaderLogin(selectedGroupId, teamPassword);
            };

            return (
                <div className="max-w-md mx-auto fade-in">
                    <div className="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                        {/* Tab Switcher */}
                        <div className="flex border-b border-gray-100">
                            <button
                                onClick={() => setMode('admin')}
                                className={`flex-1 py-4 text-sm font-bold transition-all ${mode === 'admin' ? 'bg-gizblue-50 text-gizblue-600' : 'text-gray-400 hover:bg-gray-50'}`}
                            >
                                Admin Access
                            </button>
                            <button
                                onClick={() => setMode('team')}
                                className={`flex-1 py-4 text-sm font-bold transition-all ${mode === 'team' ? 'bg-gizblue-50 text-gizblue-600' : 'text-gray-400 hover:bg-gray-50'}`}
                            >
                                Team Leader Access
                            </button>
                        </div>

                        <div className="p-8">
                            <div className="text-center mb-8">
                                <div className="inline-flex items-center justify-center w-16 h-16 bg-gizblue-100 rounded-full mb-4">
                                    {mode === 'admin' ? <Lock className="w-8 h-8 text-gizblue-600" /> : <Users className="w-8 h-8 text-gizblue-600" />}
                                </div>
                                <h2 className="text-2xl font-bold text-gray-900">{mode === 'admin' ? 'Admin Portal' : 'Team Portal'}</h2>
                                <p className="text-gray-600 mt-2 text-sm">
                                    {mode === 'admin' ? 'Enter master passcode to continue' : 'Select your team and enter leader password'}
                                </p>
                            </div>

                            {mode === 'admin' ? (
                                <form onSubmit={handleAdminLogin} className="space-y-6">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Passcode</label>
                                        <input
                                            type="password"
                                            value={passcode}
                                            onChange={(e) => setPasscode(e.target.value)}
                                            className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-gizblue-500 focus:border-transparent transition-all ${loginError ? 'border-gopared-500 animate-shake' : 'border-gray-200'}`}
                                            placeholder="Enter passcode"
                                            autoFocus
                                        />
                                        {loginError && (
                                            <p className="mt-2 text-sm text-gopared-600 flex items-center">
                                                <AlertCircle className="w-4 h-4 mr-1" /> Incorrect passcode
                                            </p>
                                        )}
                                    </div>
                                    <button
                                        type="submit"
                                        className="w-full bg-gizblue-600 text-white font-bold py-3 px-6 rounded-2xl hover:bg-gizblue-700 transition-all shadow-lg shadow-gizblue-200"
                                    >
                                        Access Admin Panel
                                    </button>
                                </form>
                            ) : (
                                <form onSubmit={onTeamSubmit} className="space-y-6">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Select Team</label>
                                        <select
                                            value={selectedGroupId}
                                            onChange={(e) => setSelectedGroupId(e.target.value)}
                                            className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-gizblue-500 focus:border-transparent"
                                        >
                                            <option value="">-- Choose Team --</option>
                                            {groups.map(g => (
                                                <option key={g.id} value={g.id}>{g.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Leader Password</label>
                                        <input
                                            type="password"
                                            value={teamPassword}
                                            onChange={(e) => setTeamPassword(e.target.value)}
                                            className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-gizblue-500 focus:border-transparent transition-all ${teamLoginError ? 'border-gopared-500 animate-shake' : 'border-gray-200'}`}
                                            placeholder="Enter password"
                                        />
                                        {teamLoginError && (
                                            <p className="mt-2 text-sm text-gopared-600 flex items-center">
                                                <AlertCircle className="w-4 h-4 mr-1" /> Invalid password
                                            </p>
                                        )}
                                    </div>
                                    <button
                                        type="submit"
                                        className="w-full bg-gizblue-600 text-white font-bold py-3 px-6 rounded-2xl hover:bg-gizblue-700 transition-all shadow-lg shadow-gizblue-200"
                                    >
                                        Access Team Dashboard
                                    </button>
                                </form>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const TeamLeaderDashboard = ({ group, leader, bges, msmes, assignments, reports }) => {
            const [activeTab, setActiveTab] = useState('overview');

            const teamMembers = bges.filter(b => group.memberIds.includes(b.id));
            const teamMemberIds = teamMembers.map(m => m.id);
            const teamAssignments = assignments.filter(a => teamMemberIds.includes(a.bgeId));
            const teamAssignmentIds = teamAssignments.map(a => a.id);
            const teamReports = reports.filter(r => teamMembers.some(m => m.name === r.bgeName)); // Linking by name as reports use name

            const assignedMsmes = msmes.filter(m => teamAssignments.some(a => a.msmeId === m.id));

            return (
                <div className="flex flex-col lg:flex-row bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100 min-h-[800px] fade-in">
                    {/* Sidebar */}
                    <div className="w-full lg:w-64 bg-gray-50 border-r border-gray-100 p-6 flex flex-col shrink-0">
                        <div className="mb-6 flex items-center justify-between lg:block">
                            <div>
                                <h2 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Team Portal</h2>
                                <h3 className="text-lg font-black text-gizblue-800">{group.name}</h3>
                                <p className="text-xs text-gray-500">Leader: {leader.name}</p>
                            </div>
                        </div>
                        <nav className="flex lg:flex-col space-x-2 lg:space-x-0 lg:space-y-2 overflow-x-auto pb-2 lg:pb-0">
                            <SidebarItem id="overview" activeTab={activeTab} setActiveTab={setActiveTab} label="Overview" icon={Layout} />
                            <SidebarItem id="members" activeTab={activeTab} setActiveTab={setActiveTab} label="Team Members" icon={Users} />
                            <SidebarItem id="assignments" activeTab={activeTab} setActiveTab={setActiveTab} label="Assignments" icon={LinkIcon} />
                            <SidebarItem id="reports" activeTab={activeTab} setActiveTab={setActiveTab} label="Team Reports" icon={FileText} />
                        </nav>
                        <div className="mt-auto pt-6 border-t border-gray-200">
                            <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
                                <p className="text-xs text-gray-400 font-semibold mb-2">Team Stats</p>
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-xs text-gray-600">Members</span>
                                    <span className="text-xs font-bold text-gray-900">{teamMembers.length}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-xs text-gray-600">Reports</span>
                                    <span className="text-xs font-bold text-gizblue-600">{teamReports.length}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 flex flex-col">
                        <div className="h-20 border-b border-gray-100 px-8 flex items-center justify-between bg-white">
                            <h3 className="text-xl font-bold text-gray-800 capitalize">
                                {activeTab === 'overview' ? 'Team Overview' : activeTab.replace(/([A-Z])/g, ' $1')}
                            </h3>
                            <div className="w-8 h-8 rounded-full bg-gizblue-100 flex items-center justify-center text-gizblue-600 text-xs font-bold">
                                TM
                            </div>
                        </div>

                        <div className="p-8 flex-1 overflow-y-auto">
                            {activeTab === 'overview' && (
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <StatCard label="Team Members" value={teamMembers.length} icon={Users} color="green" />
                                    <StatCard label="Assigned MSMEs" value={assignedMsmes.length} icon={Building} color="blue" />
                                    <StatCard label="Reports Submitted" value={teamReports.length} icon={FileText} color="gizblue" />
                                </div>
                            )}

                            {activeTab === 'members' && (
                                <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-gray-50 text-[10px] uppercase text-gray-500 font-bold">
                                            <tr>
                                                <th className="px-6 py-4">BGE Name</th>
                                                <th className="px-6 py-4">Location</th>
                                                <th className="px-6 py-4">Code</th>
                                                <th className="px-6 py-4">Reports</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100 text-sm md:text-base">
                                            {teamMembers.map(m => {
                                                const memberReports = teamReports.filter(r => r.bgeName === m.name).length;
                                                return (
                                                    <tr key={m.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 font-bold text-gray-900">{m.name}</td>
                                                        <td className="px-6 py-4 text-gray-600">{m.location}</td>
                                                        <td className="px-6 py-4 font-mono text-xs text-gray-400">{m.code}</td>
                                                        <td className="px-6 py-4 font-bold text-gizblue-600">{memberReports}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            {activeTab === 'assignments' && (
                                <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-gray-50 text-[10px] uppercase text-gray-500 font-bold">
                                            <tr>
                                                <th className="px-6 py-4">Business</th>
                                                <th className="px-6 py-4">Assigned To</th>
                                                <th className="px-6 py-4">Location</th>
                                                <th className="px-6 py-4">Contact</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100 text-sm md:text-base">
                                            {teamAssignments.map(a => {
                                                const bge = bges.find(b => b.id === a.bgeId);
                                                const msme = msmes.find(m => m.id === a.msmeId);
                                                if (!bge || !msme) return null;
                                                return (
                                                    <tr key={a.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 font-bold text-gray-900">{msme.name}</td>
                                                        <td className="px-6 py-4 text-gray-600">{bge.name}</td>
                                                        <td className="px-6 py-4 text-gray-500 text-xs">{msme.location}</td>
                                                        <td className="px-6 py-4 text-gray-500 text-xs">{msme.contactPerson} <br /> {msme.mobile}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            {activeTab === 'reports' && (
                                <div className="space-y-4">
                                    {teamReports.map(report => (
                                        <div key={report.id} className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-all">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h4 className="font-bold text-gray-900">{report.businessName}</h4>
                                                    <p className="text-xs text-gray-500">
                                                        By <span className="font-bold text-gizblue-600">{report.bgeName}</span> â€¢ {report.date}
                                                    </p>
                                                </div>
                                                {report.gpsCaptured && (
                                                    <span className="px-2 py-1 bg-gizgreen-50 text-gizgreen-700 text-[10px] font-bold rounded-md">GPS Verified</span>
                                                )}
                                            </div>
                                            <div className="mt-4 grid grid-cols-2 gap-4 text-sm text-gray-600">
                                                <div className="bg-gray-50 p-3 rounded-xl">
                                                    <span className="block text-[10px] font-bold text-gray-400 uppercase">Objectives</span>
                                                    {report.objectives}
                                                </div>
                                                <div className="bg-gray-50 p-3 rounded-xl">
                                                    <span className="block text-[10px] font-bold text-gray-400 uppercase">Activities</span>
                                                    {report.activities}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {teamReports.length === 0 && (
                                        <p className="text-center text-gray-400 py-12 italic">No reports submitted by your team yet.</p>
                                    )}
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        // Admin Panel Component
        // BGE Table Component with Inline Editing
        const BgeTable = ({ bges, onDelete, editingBge, setEditingBge, onUpdate, handleSort, bgeSort }) => {
            const [localEdit, setLocalEdit] = useState(null);

            useEffect(() => {
                if (editingBge) setLocalEdit({ ...editingBge });
                else setLocalEdit(null);
            }, [editingBge]);

            return (
                <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-x-auto">
                    <table className="w-full text-left border-collapse table-fixed">
                        <thead>
                            <tr className="bg-gray-50 text-gray-500 text-[10px] uppercase tracking-widest border-b border-gray-100">
                                <th className="px-6 py-4 font-bold w-[25%] text-[10px] uppercase tracking-widest">
                                    <div className="flex items-center space-x-1 group/sort">
                                        <SortButton
                                            label="BGE Name"
                                            active={bgeSort.key === 'name'}
                                            direction={bgeSort.dir}
                                            onClick={() => handleSort('bge', 'name')}
                                        />
                                    </div>
                                </th>
                                <th className="px-6 py-4 font-bold w-[15%] text-[10px] uppercase tracking-widest">
                                    <div className="flex items-center space-x-1 group/sort">
                                        <SortButton
                                            label="Location"
                                            active={bgeSort.key === 'location'}
                                            direction={bgeSort.dir}
                                            onClick={() => handleSort('bge', 'location')}
                                        />
                                    </div>
                                </th>
                                <th className="px-6 py-4 font-bold w-[10%] text-[10px] uppercase tracking-widest">
                                    <div className="flex items-center space-x-1 group/sort">
                                        <SortButton
                                            label="Code"
                                            active={bgeSort.key === 'code'}
                                            direction={bgeSort.dir}
                                            onClick={() => handleSort('bge', 'code')}
                                        />
                                    </div>
                                </th>
                                <th className="px-6 py-4 font-bold uppercase tracking-widest w-[25%] text-[10px]">Email Address</th>
                                <th className="px-6 py-4 font-bold uppercase tracking-widest w-[15%] text-[10px]">Specialisation</th>
                                <th className="px-6 py-4 font-bold text-right w-[10%] uppercase tracking-widest text-[10px]">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50">
                            {bges.map(bge => {
                                const isEditing = editingBge && editingBge.id === bge.id;
                                return (
                                    <tr key={bge.id} className={`hover:bg-gizblue-50/30 transition-colors group ${isEditing ? 'bg-gizblue-50/50' : ''}`}>
                                        <td className="px-6 py-4">
                                            {isEditing ? (
                                                <input
                                                    type="text"
                                                    value={localEdit.name}
                                                    onChange={(e) => setLocalEdit({ ...localEdit, name: e.target.value })}
                                                    className="w-full bg-white border border-gizblue-300 rounded-xl px-3 py-2 text-sm font-bold focus:ring-2 focus:ring-gizblue-500"
                                                />
                                            ) : (
                                                <div className="font-bold text-gray-900 truncate" title={bge.name}>{bge.name}</div>
                                            )}
                                        </td>
                                        <td className="px-6 py-4">
                                            {isEditing ? (
                                                <input
                                                    type="text"
                                                    value={localEdit.location}
                                                    onChange={(e) => setLocalEdit({ ...localEdit, location: e.target.value })}
                                                    className="w-full bg-white border border-gizblue-300 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-gizblue-500"
                                                />
                                            ) : (
                                                <div className="text-sm text-gray-600 truncate" title={bge.location}>{bge.location}</div>
                                            )}
                                        </td>
                                        <td className="px-6 py-4">
                                            {isEditing ? (
                                                <input
                                                    type="text"
                                                    value={localEdit.code}
                                                    onChange={(e) => setLocalEdit({ ...localEdit, code: e.target.value })}
                                                    className="w-full bg-white border border-gizblue-300 rounded-xl px-3 py-2 text-sm font-mono text-gizblue-600 focus:ring-2 focus:ring-gizblue-500"
                                                />
                                            ) : (
                                                <div className="text-sm font-mono text-gizblue-600">{bge.code}</div>
                                            )}
                                        </td>
                                        <td className="px-6 py-4">
                                            {isEditing ? (
                                                <input
                                                    type="email"
                                                    value={localEdit.email}
                                                    onChange={(e) => setLocalEdit({ ...localEdit, email: e.target.value })}
                                                    placeholder="Email"
                                                    className="w-full bg-white border border-gizblue-300 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-gizblue-500"
                                                />
                                            ) : (
                                                <div className="text-sm text-gray-600 truncate" title={bge.email || '-'}>{bge.email || '-'}</div>
                                            )}
                                        </td>
                                        <td className="px-6 py-4">
                                            {isEditing ? (
                                                <input
                                                    type="text"
                                                    value={localEdit.specialisation}
                                                    onChange={(e) => setLocalEdit({ ...localEdit, specialisation: e.target.value })}
                                                    className="w-full bg-white border border-gizblue-300 rounded-xl px-3 py-2 text-sm italic focus:ring-2 focus:ring-gizblue-500"
                                                />
                                            ) : (
                                                <div className="text-sm text-gray-500 italic truncate" title={bge.specialisation || '-'}>{bge.specialisation || '-'}</div>
                                            )}
                                        </td>
                                        <td className="px-6 py-4 text-right">
                                            {isEditing ? (
                                                <div className="flex justify-end space-x-1">
                                                    <button
                                                        onClick={() => onUpdate(bge.id, localEdit)}
                                                        className="p-2 bg-gizgreen-600 text-white rounded-2xl hover:bg-green-700 transition-all shadow-sm"
                                                        title="Save Changes"
                                                    >
                                                        <Save className="w-4 h-4" />
                                                    </button>
                                                    <button
                                                        onClick={() => setEditingBge(null)}
                                                        className="p-2 bg-gray-200 text-gray-600 rounded-2xl hover:bg-gray-300 transition-all"
                                                        title="Cancel"
                                                    >
                                                        <X className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="flex justify-end space-x-1">
                                                    <button
                                                        onClick={() => setEditingBge(bge)}
                                                        className="text-gizblue-400 hover:text-gizblue-600 opacity-0 group-hover:opacity-100 transition-all p-2 bg-gizblue-50 rounded-2xl"
                                                        title="Edit BGE"
                                                    >
                                                        <Edit2 className="w-4 h-4" />
                                                    </button>
                                                    <button
                                                        onClick={() => onDelete(bge.id)}
                                                        className="text-red-400 hover:text-gopared-600 opacity-0 group-hover:opacity-100 transition-all p-2 bg-gopared-50 rounded-2xl"
                                                        title="Delete BGE"
                                                    >
                                                        <Trash2 className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                            {bges.length === 0 && (
                                <tr>
                                    <td colSpan="5" className="px-6 py-12 text-center text-gray-400">No BGEs found matching your search.</td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            );
        };

        // MSME Table Component with Inline Editing
        const MsmeTable = ({ msmes, onDelete, editingMsme, setEditingMsme, onUpdate, handleSort, msmeSort, cohort }) => {
            const [localEdit, setLocalEdit] = useState(null);

            useEffect(() => {
                if (editingMsme) setLocalEdit({ ...editingMsme });
                else setLocalEdit(null);
            }, [editingMsme]);

            const isCohort1 = cohort === '1';
            const emptyColSpan = isCohort1 ? 9 : 8;

            return (
                <div className="w-full bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden">
                    <div className="w-full overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-gray-50 text-gray-500 text-[10px] uppercase tracking-widest border-b border-gray-100">
                                    <th className="px-6 py-4 font-bold w-[20%]">
                                        <SortButton
                                            label="Name of Enterprise"
                                            active={msmeSort.key === 'name'}
                                            direction={msmeSort.dir}
                                            onClick={() => handleSort('msme', 'name')}
                                        />
                                    </th>

                                    {isCohort1 ? (
                                        <>
                                            {/* Cohort 1 Columns */}
                                            <th className="px-4 py-4 font-bold w-[15%]">Business Owner</th>
                                            <th className="px-4 py-4 font-bold w-[10%]">Owner Details</th>
                                            <th className="px-4 py-4 font-bold w-[8%]">Sex/Age</th>
                                            <th className="px-4 py-4 font-bold w-[12%]">Education</th>
                                            <th className="px-4 py-4 font-bold w-[10%]">Business Type</th>
                                            <th className="px-4 py-4 font-bold w-[12%]">Location</th>
                                            <th className="px-4 py-4 font-bold w-[8%]">Contacts</th>
                                        </>
                                    ) : (
                                        <>
                                            {/* Cohort 2 Columns */}
                                            <th className="px-4 py-4 font-bold w-[10%]">Location</th>
                                            <th className="px-4 py-4 font-bold w-[20%]">Physical Address</th>
                                            <th className="px-4 py-4 font-bold w-[15%]">Key Contact</th>
                                            <th className="px-4 py-4 font-bold w-[8%]">Role</th>
                                            <th className="px-4 py-4 font-bold w-[12%]">Contact Details</th>
                                            <th className="px-4 py-4 font-bold w-[10%]">Founder</th>
                                        </>
                                    )}

                                    <th className="px-6 py-4 font-bold text-right w-[5%] uppercase tracking-widest">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-50">
                                {msmes.map(msme => {
                                    const isEditing = editingMsme && editingMsme.id === msme.id;
                                    return (
                                        <tr key={msme.id} className={`hover:bg-gizblue-50/30 transition-colors group ${isEditing ? 'bg-gizblue-50/50' : ''}`}>
                                            <td className="px-6 py-4 whitespace-nowrap overflow-hidden align-top">
                                                {isEditing ? (
                                                    <input
                                                        type="text"
                                                        value={localEdit.name}
                                                        onChange={(e) => setLocalEdit({ ...localEdit, name: e.target.value })}
                                                        className="w-full bg-white border border-gizblue-300 rounded-xl px-3 py-2 text-xs font-bold focus:ring-2 focus:ring-gizblue-500"
                                                    />
                                                ) : (
                                                    <>
                                                        <div className="font-bold text-gray-900 truncate text-sm" title={msme.name}>{msme.name}</div>
                                                        <div className="text-[10px] text-gray-400 truncate">{msme.businessEmail}</div>
                                                    </>
                                                )}
                                            </td>

                                            {isCohort1 ? (
                                                <>
                                                    {/* Cohort 1 Data */}
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <input type="text" value={localEdit.ownerName} placeholder="Owner Name" onChange={(e) => setLocalEdit({ ...localEdit, ownerName: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-xs" />
                                                        ) : (
                                                            <div className="text-xs font-medium text-gray-700">{msme.ownerName || '-'}</div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <div className="space-y-1">
                                                                <input type="text" value={localEdit.ownerEmail} placeholder="Email" onChange={(e) => setLocalEdit({ ...localEdit, ownerEmail: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                                <input type="text" value={localEdit.ownerMobile} placeholder="Mobile" onChange={(e) => setLocalEdit({ ...localEdit, ownerMobile: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-0.5">
                                                                {msme.ownerEmail && <div className="text-[10px] text-gray-500 truncate" title={msme.ownerEmail}>{msme.ownerEmail}</div>}
                                                                {msme.ownerMobile && <div className="text-[10px] text-gizblue-600 font-mono">{msme.ownerMobile}</div>}
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <div className="grid grid-cols-2 gap-1">
                                                                <input type="text" value={localEdit.ownerSex} placeholder="Sex" onChange={(e) => setLocalEdit({ ...localEdit, ownerSex: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                                <input type="text" value={localEdit.ownerAge} placeholder="Age" onChange={(e) => setLocalEdit({ ...localEdit, ownerAge: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                            </div>
                                                        ) : (
                                                            <div className="text-xs text-gray-600">{msme.ownerSex} {msme.ownerAge ? `(${msme.ownerAge})` : ''}</div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <input type="text" value={localEdit.education} placeholder="Education" onChange={(e) => setLocalEdit({ ...localEdit, education: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-xs" />
                                                        ) : (
                                                            <div className="text-xs text-gray-600 truncate" title={msme.education}>{msme.education || '-'}</div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <input type="text" value={localEdit.businessType} placeholder="Business Type" onChange={(e) => setLocalEdit({ ...localEdit, businessType: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-xs" />
                                                        ) : (
                                                            <div className="text-xs text-gray-600 truncate" title={msme.businessType}>{msme.businessType || '-'}</div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <div className="space-y-1">
                                                                <input type="text" value={localEdit.district} placeholder="District" onChange={(e) => setLocalEdit({ ...localEdit, district: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                                <input type="text" value={localEdit.townCity} placeholder="Town" onChange={(e) => setLocalEdit({ ...localEdit, townCity: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-0.5">
                                                                <div className="text-xs font-medium text-gray-900">{msme.district}</div>
                                                                <div className="text-[10px] text-gray-500">{msme.townCity}</div>
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <input type="text" value={localEdit.businessMobile} placeholder="Phone" onChange={(e) => setLocalEdit({ ...localEdit, businessMobile: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-xs" />
                                                        ) : (
                                                            <div className="text-xs text-mono text-gray-600">{msme.businessMobile || '-'}</div>
                                                        )}
                                                    </td>
                                                </>
                                            ) : (
                                                <>
                                                    {/* Cohort 2 Data */}
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <div className="space-y-1">
                                                                <input type="text" value={localEdit.district} placeholder="District" onChange={(e) => setLocalEdit({ ...localEdit, district: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                                <input type="text" value={localEdit.townCity} placeholder="Town" onChange={(e) => setLocalEdit({ ...localEdit, townCity: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-0.5">
                                                                <div className="text-xs font-medium text-gray-900">{msme.district}</div>
                                                                <div className="text-[10px] text-gray-500">{msme.townCity}</div>
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <input type="text" value={localEdit.location} placeholder="Physical Location" onChange={(e) => setLocalEdit({ ...localEdit, location: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-xs" />
                                                        ) : (
                                                            <div className="text-xs text-gray-600 truncate" title={msme.location}>{msme.location || '-'}</div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <div className="space-y-1">
                                                                <input type="text" value={localEdit.contactPerson} placeholder="Name" onChange={(e) => setLocalEdit({ ...localEdit, contactPerson: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-xs" />
                                                                <input type="text" value={localEdit.contactGender} placeholder="Gender" onChange={(e) => setLocalEdit({ ...localEdit, contactGender: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-0.5">
                                                                <div className="text-xs font-medium text-gray-900">{msme.contactPerson}</div>
                                                                <div className="text-[10px] text-gray-500">{msme.contactGender || ''}</div>
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <input type="text" value={localEdit.businessRole} placeholder="Role" onChange={(e) => setLocalEdit({ ...localEdit, businessRole: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-xs" />
                                                        ) : (
                                                            <div className="text-xs text-gray-500 italic mb-1">{msme.businessRole}</div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <div className="space-y-1">
                                                                <input type="text" value={localEdit.mobile} placeholder="Mobile" onChange={(e) => setLocalEdit({ ...localEdit, mobile: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                                <input type="text" value={localEdit.contactEmail} placeholder="Email" onChange={(e) => setLocalEdit({ ...localEdit, contactEmail: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-0.5">
                                                                {msme.mobile && <div className="text-[10px] text-gizblue-600 font-mono">{msme.mobile}</div>}
                                                                {msme.contactEmail && <div className="text-[10px] text-gray-400 truncate" title={msme.contactEmail}>{msme.contactEmail}</div>}
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-4 whitespace-nowrap overflow-hidden align-top">
                                                        {isEditing ? (
                                                            <div className="space-y-1">
                                                                <input type="text" value={localEdit.founderName} placeholder="Founder Name" onChange={(e) => setLocalEdit({ ...localEdit, founderName: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                                <input type="text" value={localEdit.founderSex} placeholder="Sex" onChange={(e) => setLocalEdit({ ...localEdit, founderSex: e.target.value })} className="w-full bg-white border border-gizblue-300 rounded-xl px-2 py-1 text-[10px]" />
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-0.5">
                                                                {msme.founderName && <div className="text-xs text-gray-700">{msme.founderName}</div>}
                                                                {msme.founderSex && <div className="text-[10px] text-gray-500">{msme.founderSex}</div>}
                                                            </div>
                                                        )}
                                                    </td>
                                                </>
                                            )}

                                            <td className="px-6 py-4 text-right align-top">
                                                {isEditing ? (
                                                    <div className="flex justify-end space-x-1">
                                                        <button
                                                            onClick={() => onUpdate(msme.id, localEdit)}
                                                            className="p-2 bg-gizgreen-600 text-white rounded-2xl hover:bg-green-700 transition-all shadow-sm"
                                                            title="Save Changes"
                                                        >
                                                            <Save className="w-4 h-4" />
                                                        </button>
                                                        <button
                                                            onClick={() => setEditingMsme(null)}
                                                            className="p-2 bg-gray-200 text-gray-600 rounded-2xl hover:bg-gray-300 transition-all"
                                                            title="Cancel"
                                                        >
                                                            <X className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <div className="flex justify-end space-x-1">
                                                        <button
                                                            onClick={() => setEditingMsme(msme)}
                                                            className="text-gizblue-400 hover:text-gizblue-600 opacity-0 group-hover:opacity-100 transition-all p-2 bg-gizblue-50 rounded-2xl"
                                                            title="Edit MSME"
                                                        >
                                                            <Edit2 className="w-4 h-4" />
                                                        </button>
                                                        <button
                                                            onClick={() => onDelete(msme.id)}
                                                            className="text-red-400 hover:text-gopared-600 opacity-0 group-hover:opacity-100 transition-all p-2 bg-gopared-50 rounded-2xl"
                                                            title="Delete MSME"
                                                        >
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })}
                                {msmes.length === 0 && (
                                    <tr>
                                        <td colSpan={emptyColSpan} className="px-6 py-12 text-center text-gray-400">No MSMEs found matching your search.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Group Management Component
        const GroupManagement = ({ groups, setGroups, bges }) => {
            const [newGroupName, setNewGroupName] = useState('');
            const [newGroupLeaderId, setNewGroupLeaderId] = useState('');
            const [newGroupPassword, setNewGroupPassword] = useState('');
            const [editingGroup, setEditingGroup] = useState(null);

            const handleCreateGroup = (e) => {
                e.preventDefault();
                if (!newGroupName || !newGroupLeaderId || !newGroupPassword) {
                    alert('Please fill in all fields (Name, Leader, Password)');
                    return;
                }

                const newGroup = {
                    id: 'g' + Date.now(),
                    name: newGroupName,
                    leaderId: newGroupLeaderId,
                    password: newGroupPassword,
                    memberIds: [newGroupLeaderId] // Leader is automatically a member
                };

                setGroups(prev => [...prev, newGroup]);
                setNewGroupName('');
                setNewGroupLeaderId('');
                setNewGroupPassword('');
                alert('Group created successfully!');
            };

            const handleDeleteGroup = (id) => {
                if (confirm('Are you sure you want to delete this group?')) {
                    setGroups(prev => prev.filter(g => g.id !== id));
                }
            };

            const toggleMemberInGroup = (groupId, bgeId) => {
                setGroups(prev => prev.map(g => {
                    if (g.id !== groupId) return g;
                    const isMember = g.memberIds.includes(bgeId);
                    return {
                        ...g,
                        memberIds: isMember
                            ? g.memberIds.filter(id => id !== bgeId)
                            : [...g.memberIds, bgeId]
                    };
                }));
            };

            return (
                <div className="space-y-8">
                    {/* Create Group Form */}
                    <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                        <h4 className="font-bold text-gray-800 mb-4">Create New Team</h4>
                        <form onSubmit={handleCreateGroup} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Team Name</label>
                                <input
                                    type="text"
                                    value={newGroupName}
                                    onChange={(e) => setNewGroupName(e.target.value)}
                                    className="w-full bg-gray-50 border-none rounded-2xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-gizblue-500"
                                    placeholder="e.g. Team Alpha"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Team Leader</label>
                                <select
                                    value={newGroupLeaderId}
                                    onChange={(e) => setNewGroupLeaderId(e.target.value)}
                                    className="w-full bg-gray-50 border-none rounded-2xl px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-gizblue-500"
                                >
                                    <option value="">-- Select Leader --</option>
                                    {bges.map(b => (
                                        <option key={b.id} value={b.id}>{b.name} ({b.code})</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Leader Password</label>
                                <input
                                    type="text"
                                    value={newGroupPassword}
                                    onChange={(e) => setNewGroupPassword(e.target.value)}
                                    className="w-full bg-gray-50 border-none rounded-2xl px-4 py-3 text-sm font-mono focus:ring-2 focus:ring-gizblue-500"
                                    placeholder="Set login password"
                                />
                            </div>
                            <button
                                type="submit"
                                className="bg-gizblue-600 text-white py-3 px-6 rounded-2xl font-bold shadow-lg shadow-gizblue-100 hover:bg-gizblue-700 transition-all"
                            >
                                Create Group
                            </button>
                        </form>
                    </div>

                    {/* Groups List */}
                    <div className="space-y-4">
                        <h4 className="font-bold text-gray-800">Existing Teams</h4>
                        {groups.length === 0 && (
                            <p className="text-gray-400 text-sm italic">No groups created yet.</p>
                        )}
                        <div className="grid grid-cols-1 gap-4">
                            {groups.map(group => {
                                const leader = bges.find(b => b.id === group.leaderId);
                                const isExpanded = editingGroup === group.id;

                                return (
                                    <div key={group.id} className="bg-white border border-gray-100 rounded-3xl overflow-hidden shadow-sm transition-all">
                                        <div className="p-6 flex items-center justify-between">
                                            <div className="flex items-center space-x-4">
                                                <div className="p-3 bg-gizblue-50 rounded-2xl text-gizblue-600">
                                                    <Users className="w-6 h-6" />
                                                </div>
                                                <div>
                                                    <h5 className="font-bold text-gray-900 text-lg">{group.name}</h5>
                                                    <p className="text-xs text-gray-500">
                                                        Leader: <span className="font-bold text-gizblue-600">{leader?.name || 'Unknown'}</span> â€¢ {group.memberIds.length} Members
                                                    </p>
                                                    <p className="text-[10px] text-gray-400 font-mono mt-1">Pass: {group.password}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <button
                                                    onClick={() => setEditingGroup(isExpanded ? null : group.id)}
                                                    className={`px-4 py-2 rounded-2xl text-xs font-bold transition-all ${isExpanded ? 'bg-gizblue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                                >
                                                    {isExpanded ? 'Done' : 'Manage Members'}
                                                </button>
                                                <button
                                                    onClick={() => handleDeleteGroup(group.id)}
                                                    className="p-3 text-red-400 hover:text-gopared-600 hover:bg-gopared-50 rounded-2xl transition-all"
                                                >
                                                    <Trash2 className="w-5 h-5" />
                                                </button>
                                            </div>
                                        </div>

                                        {/* Member Selection Area */}
                                        {isExpanded && (
                                            <div className="border-t border-gray-100 bg-gray-50/50 p-6 animate-in fade-in slide-in-from-top-2">
                                                <h6 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Select Team Members</h6>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                                    {bges.map(bge => {
                                                        const isMember = group.memberIds.includes(bge.id);
                                                        const isLeader = bge.id === group.leaderId;
                                                        return (
                                                            <button
                                                                key={bge.id}
                                                                onClick={() => !isLeader && toggleMemberInGroup(group.id, bge.id)}
                                                                className={`p-3 rounded-2xl text-left border transition-all ${isMember
                                                                    ? 'bg-gizblue-600 text-white border-gizblue-600 shadow-md'
                                                                    : 'bg-white border-gray-200 text-gray-600 hover:border-gizblue-300'
                                                                    } ${isLeader ? 'opacity-80 cursor-default ring-2 ring-offset-2 ring-gizblue-600' : ''}`}
                                                            >
                                                                <div className="font-bold text-sm truncate">{bge.name}</div>
                                                                <div className={`text-[10px] font-mono mt-1 ${isMember ? 'text-gizblue-200' : 'text-gray-400'}`}>
                                                                    {bge.code} {isLeader && '(LEADER)'}
                                                                </div>
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const BgeEmailButton = ({ bge, assignments, msmes }) => {
            const [copied, setCopied] = useState(false);

            const handleEmail = () => {
                const assignedMsmes = assignments.map(a => msmes.find(m => m.id === a.msmeId)).filter(Boolean);
                if (assignedMsmes.length === 0) {
                    alert('No assignments to email.');
                    return;
                }

                const subject = encodeURIComponent(`New MSME Assignments - PRUDEV II`);
                const ccAddresses = "stella.abote@gopa.eu,stephenmaxi.opwonya@gopa.eu";

                let body = `Dear ${bge.name},\n\nPlease find below the list of MSMEs assigned to you for the PRUDEV II project:\n\n`;
                assignedMsmes.forEach((m, i) => {
                    const phone = m.mobile || m.businessMobile || m.ownerMobile || 'N/A';
                    const email = m.contactEmail || m.businessEmail || m.ownerEmail || 'N/A';
                    const location = m.location || m.townCity || m.district || 'N/A';
                    const physicalAddress = m.location || 'N/A';

                    body += `${i + 1}. ${m.name}\n`;
                    body += `   - Town/District: ${location}\n`;
                    body += `   - Physical Location: ${physicalAddress}\n`;
                    body += `   - Contact Person: ${m.contactPerson || m.ownerName || 'N/A'}\n`;
                    body += `   - Phone: ${phone}\n`;
                    body += `   - Email: ${email}\n\n`;
                });
                body += `Please prioritize contacting them this week.\n\nBest regards,\nPRUDEV II Admin Team`;

                const mailtoLink = `mailto:${bge.email || ''}?cc=${ccAddresses}&subject=${subject}&body=${encodeURIComponent(body)}`;

                // Check length limits (approx 2000 chars for safe mailto)
                if (mailtoLink.length > 2000) {
                    navigator.clipboard.writeText(body).then(() => {
                        setCopied(true);
                        setTimeout(() => setCopied(false), 3000);
                        alert('The email body is too long for a direct link. The content has been copied to your clipboard. Please paste it into your email client.');
                    });
                } else {
                    window.location.href = mailtoLink;
                }
            };

            return (
                <button
                    onClick={handleEmail}
                    className="mt-2 flex items-center space-x-1 text-xs font-bold text-gray-500 hover:text-gizblue-600 transition-colors px-2 py-1 rounded-md hover:bg-gizblue-50"
                    title="Email Assignment List"
                >
                    {copied ? <Check className="w-4 h-4" /> : <Mail className="w-4 h-4" />}
                    <span>{copied ? 'Copied' : 'Email List'}</span>
                </button>
            );
        };

        const MsmeEmailButton = ({ msme, bge }) => {
            const handleEmail = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!msme.contactEmail && !msme.businessEmail && !msme.ownerEmail) {
                    alert('No email address found for this MSME.');
                    return;
                }

                const email = msme.contactEmail || msme.businessEmail || msme.ownerEmail;
                const subject = encodeURIComponent(`Your BGE Assignment - PRUDEV II`);
                const body = encodeURIComponent(`Dear ${msme.contactPerson || msme.ownerName || msme.name},\n\nWe are pleased to inform you that you have been matched with a Business Growth Expert (BGE) as part of the PRUDEV II MSME Support Program.\n\nYour assigned expert will support you with technical assistance and business diagnostic services to help grow your enterprise.\n\nExpert Profile:\n- Name: ${bge.name}\n- Specialisation: ${bge.specialisation || 'Business Development and Strategy Support'}\n\nPlease expect a call or visit from ${bge.name} within the next few days to schedule your first diagnostic meeting. We look forward to seeing your business thrive through this partnership.\n\nBest regards,\nPRUDEV II Project Team\nGIZ-PRUDEV Support Portal`);

                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            };

            return (
                <button
                    onClick={handleEmail}
                    className="p-2 text-gray-400 hover:text-gizblue-600 transition-colors bg-white rounded-full shadow-sm hover:shadow-md mr-2"
                    title="Email BGE Profile to MSME"
                >
                    <Mail className="w-4 h-4" />
                </button>
            );
        };

        const AdminPanel = ({
            bges, setBges, msmes, setMsmes, assignments, setAssignments, reports, setReports,
            addBge, deleteBge, addMsme, deleteMsme, clearAllMsmes, addAssignment, deleteAssignment,
            getBgeAssignments, editingBge, setEditingBge, editingMsme, setEditingMsme, groups, setGroups
        }) => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedCohort, setSelectedCohort] = useState('1');
            const [searchQuery, setSearchQuery] = useState('');
            const [expandedBgeId, setExpandedBgeId] = useState(null);

            // Sorting & Filtering State
            const [bgeSort, setBgeSort] = useState({ key: 'name', dir: 'asc' });
            const [msmeSort, setMsmeSort] = useState({ key: 'name', dir: 'asc' });
            const [msmeLocationFilter, setMsmeLocationFilter] = useState('all');
            const [leaderboardSort, setLeaderboardSort] = useState('reports'); // 'reports' or 'msmes'

            // Selection for Matrix Export
            const [selectedBgeIds, setSelectedBgeIds] = useState([]);

            const toggleBgeSelection = (id) => {
                setSelectedBgeIds(prev =>
                    prev.includes(id) ? prev.filter(bId => bId !== id) : [...prev, id]
                );
            };

            const selectAllBges = () => {
                if (selectedBgeIds.length === bges.length) setSelectedBgeIds([]);
                else setSelectedBgeIds(bges.map(b => b.id));
            };

            const handleSort = (type, key) => {
                const current = type === 'bge' ? bgeSort : msmeSort;
                const setSort = type === 'bge' ? setBgeSort : setMsmeSort;
                const dir = current.key === key && current.dir === 'asc' ? 'desc' : 'asc';
                setSort({ key, dir });
            };

            const sortData = (data, config) => {
                return [...data].sort((a, b) => {
                    const valA = (a[config.key] || '').toString().toLowerCase();
                    const valB = (b[config.key] || '').toString().toLowerCase();
                    if (valA < valB) return config.dir === 'asc' ? -1 : 1;
                    if (valA > valB) return config.dir === 'asc' ? 1 : -1;
                    return 0;
                });
            };

            const stats = {
                totalBges: bges.length,
                totalMsmes: msmes.length,
                cohort1: msmes.filter(m => m.cohort === '1').length,
                cohort2: msmes.filter(m => m.cohort === '2').length,
                totalAssignments: assignments.length
            };

            const filteredBges = useMemo(() => {
                const query = searchQuery.toLowerCase();
                const filtered = bges.filter(b => {
                    return (
                        (b.name || '').toLowerCase().includes(query) ||
                        (b.code || '').toLowerCase().includes(query) ||
                        ((b.specialisation || '').toLowerCase().includes(query))
                    );
                });
                return sortData(filtered, bgeSort);
            }, [bges, searchQuery, bgeSort]);

            const filteredMsmes = useMemo(() => {
                const query = searchQuery.toLowerCase();
                const filtered = msmes.filter(m => {
                    const matchesCohort = m.cohort === selectedCohort;
                    const matchesSearch = (m.name || '').toLowerCase().includes(query) ||
                        (m.location || '').toLowerCase().includes(query) ||
                        (m.district || '').toLowerCase().includes(query) ||
                        (m.townCity || '').toLowerCase().includes(query);
                    const matchesLocation = msmeLocationFilter === 'all' ||
                        (m.district === msmeLocationFilter) ||
                        (m.townCity === msmeLocationFilter);
                    return matchesCohort && matchesSearch && matchesLocation;
                });
                return sortData(filtered, msmeSort);
            }, [msmes, selectedCohort, searchQuery, msmeSort, msmeLocationFilter]);

            const uniqueLocations = useMemo(() => {
                const locations = new Set();
                msmes.filter(m => m.cohort === selectedCohort).forEach(m => {
                    if (m.district) locations.add(m.district);
                    if (m.townCity) locations.add(m.townCity);
                });
                return Array.from(locations).sort();
            }, [msmes, selectedCohort]);

            const filteredReports = useMemo(() => {
                const query = searchQuery.toLowerCase();
                return reports.filter(r =>
                    (r.bgeName || '').toLowerCase().includes(query) ||
                    (r.businessName || '').toLowerCase().includes(query) ||
                    (r.date || '').toLowerCase().includes(query)
                ).sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [reports, searchQuery]);

            return (
                <div className="flex flex-col lg:flex-row bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100 min-h-[800px] fade-in">
                    {/* Sidebar */}
                    <div className="w-full lg:w-64 bg-gray-50 border-r border-gray-100 p-4 lg:p-6 flex flex-col shrink-0">
                        <div className="mb-4 lg:mb-8 flex items-center justify-between lg:block">
                            <h2 className="text-xl font-black text-gizblue-800 tracking-tighter mb-1 lg:mb-4">PRUDEV II</h2>
                        </div>
                        <nav className="flex lg:flex-col space-x-2 lg:space-x-0 lg:space-y-2 overflow-x-auto lg:overflow-y-auto pb-2 lg:pb-0 pr-2 scrollbar-hide">
                            <SidebarItem id="dashboard" activeTab={activeTab} setActiveTab={setActiveTab} label="Dashboard" icon={Layout} />
                            <SidebarItem id="groups" activeTab={activeTab} setActiveTab={setActiveTab} label="My Teams" icon={Users} />
                            <SidebarItem id="bges" activeTab={activeTab} setActiveTab={setActiveTab} label="BGE Network" icon={UserCheck} />
                            <SidebarItem id="msmes" activeTab={activeTab} setActiveTab={setActiveTab} label="MSME Directory" icon={Building} />
                            <SidebarItem id="assignments" activeTab={activeTab} setActiveTab={setActiveTab} label="Assignments" icon={LinkIcon} />
                            <SidebarItem id="leaderboard" activeTab={activeTab} setActiveTab={setActiveTab} label="Leaderboard" icon={Trophy} />
                            <SidebarItem id="archive" activeTab={activeTab} setActiveTab={setActiveTab} label="Reports Archive" icon={FileText} />
                            <SidebarItem id="analysis" activeTab={activeTab} setActiveTab={setActiveTab} label="Report Analysis" icon={BarChart} />
                        </nav>

                        <div className="mt-auto pt-6 border-t border-gray-200">
                            <div className="bg-gizblue-50 p-4 rounded-2xl">
                                <p className="text-xs text-gizblue-600 font-semibold mb-2">Help & Docs</p>
                                <a href="DATA_IMPORT_GUIDE.md" className="text-sm text-gray-600 hover:text-gizblue-600 block">Import Guide</a>
                            </div>
                        </div>
                    </div>

                    {/* Main Content Area */}
                    <div className="flex-1 flex flex-col">
                        {/* Header */}
                        <div className="h-auto py-4 sm:py-0 sm:h-20 border-b border-gray-100 px-4 sm:px-8 flex flex-col sm:flex-row items-center justify-between bg-white gap-4 sm:gap-0">
                            <h3 className="text-xl font-bold text-gray-800 capitalize w-full sm:w-auto text-center sm:text-left">
                                {activeTab === 'dashboard' ? 'Overview' : activeTab.replace(/([A-Z])/g, ' $1')}
                            </h3>
                            <div className="flex items-center space-x-4 w-full sm:w-auto justify-center sm:justify-end">
                                <div className="relative">
                                    <input
                                        type="text"
                                        placeholder="Search records..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="pl-10 pr-4 py-2 bg-gray-50 border-none rounded-full text-sm focus:ring-2 focus:ring-gizblue-500 w-full sm:w-64 transition-all"
                                    />
                                    <svg className="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                </div>
                                <div className="w-8 h-8 rounded-full bg-gizblue-600 border-2 border-white shadow-sm flex items-center justify-center text-white text-xs font-bold">
                                    A
                                </div>
                            </div>
                        </div>

                        {/* Content Scroll Area */}
                        <div className="p-8 flex-1 overflow-y-auto">
                            {activeTab === 'dashboard' && (
                                <div className="space-y-8 animate-in fade-in duration-500">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <StatCard label="Total BGEs" value={stats.totalBges} icon={Users} color="blue" />
                                        <StatCard label="Cohort 1 MSMEs" value={stats.cohort1} icon={Building} color="green" />
                                        <StatCard label="Cohort 2 MSMEs" value={stats.cohort2} icon={Building} color="red" />
                                        <StatCard label="Total Projects" value={stats.totalAssignments} icon={Briefcase} color="gizblue" />
                                    </div>

                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        <div className="bg-gray-50 p-6 rounded-3xl border border-gray-100">
                                            <h4 className="font-bold text-gray-700 mb-4 flex items-center">
                                                <LinkIcon className="w-4 h-4 mr-2" />
                                                Quick Data Access
                                            </h4>
                                            <div className="space-y-3">
                                                <ExternalLink
                                                    href={QUICK_LINKS.BGEMasterSheet}
                                                    label="BGE Master List"
                                                    icon={Users}
                                                />
                                                <ExternalLink
                                                    href={QUICK_LINKS.msmeCohort1Sheet}
                                                    label="MSME Cohort 1 (Google Sheets)"
                                                    icon={Building}
                                                />
                                                <ExternalLink
                                                    href={QUICK_LINKS.msmeCohort2Sheet}
                                                    label="MSME Cohort 2 (Google Sheets)"
                                                    icon={Building}
                                                />
                                            </div>
                                        </div>
                                        <div className="bg-gizblue-600 p-8 rounded-3xl text-white relative overflow-hidden group">
                                            <Star className="absolute -right-4 -top-4 w-32 h-32 opacity-10 group-hover:scale-110 transition-transform" />
                                            <h4 className="text-xl font-bold mb-2">Welcome Back!</h4>
                                            <p className="text-gizblue-100 text-sm mb-6 leading-relaxed">
                                                You have {stats.totalAssignments} active assignments across {stats.totalMsmes} MSMEs.
                                                Need to update data? Use the CSV import features in the specific sections.
                                            </p>
                                            <button
                                                onClick={() => setActiveTab('assignments')}
                                                className="bg-white text-gizblue-600 px-6 py-2 rounded-full text-sm font-bold hover:bg-gizblue-50 transition-colors"
                                            >
                                                Manage Assignments
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'groups' && <GroupManagement groups={groups} setGroups={setGroups} bges={bges} />}

                            {activeTab === 'bges' && (
                                <div className="space-y-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <p className="text-gray-500 text-sm mb-2 sm:mb-0">Upload BGE list with Name, Location, Code, and optional Specialisation.</p>
                                        <div className="flex flex-wrap 2xl:flex-nowrap gap-2 w-full sm:w-auto justify-start sm:justify-end">
                                            <CSVExportButton
                                                data={bges.map(b => ({
                                                    'Name': b.name,
                                                    'Code': b.code,
                                                    'Email Address': b.email || '',
                                                    'Location': b.location,
                                                    'Specialisation': b.specialisation || ''
                                                }))}
                                                filename="bge_network"
                                                type="BGE"
                                            />
                                            <SheetSyncButton
                                                type="BGE Sheet"
                                                urlStorageKey="prudev_sheet_url_bges"
                                                onImport={(data) => {
                                                    const imported = data.map((item, i) => {
                                                        const name = item.name || item.bgename || item.fullname || item.expertname || item.Name || item.BGE_Name || item['BGE Name'];
                                                        const location = item.location || item.city || item.region || item.Location || item.Region || item.District;
                                                        const code = item.code || item.bgecode || item.expertid || item.Code || item.BGE_Code || item.ID;
                                                        const email = item.email || item.expertemail || item.bgeemail || item.Email || item['Email Address'] || '';
                                                        const specialisation = item.specialisation || item.specialization || item.skills || item.areaofspecialisation || item.areaofspecialization || item.Specialisation || item.Specialization || '';

                                                        return {
                                                            id: 'b' + Date.now() + i,
                                                            name: name || 'Unnamed BGE',
                                                            location: location || 'Unknown',
                                                            code: code || ('BGE-' + i),
                                                            email,
                                                            specialisation
                                                        };
                                                    }).filter(b => b.name && b.name !== 'Unnamed BGE');

                                                    if (imported.length > 0) {
                                                        setBges(prev => {
                                                            const next = [...prev];
                                                            imported.forEach(newItem => {
                                                                const index = next.findIndex(b =>
                                                                    (newItem.code && b.code === newItem.code) ||
                                                                    (b.name.toLowerCase() === newItem.name.toLowerCase())
                                                                );
                                                                if (index > -1) {
                                                                    next[index] = { ...next[index], ...newItem, id: next[index].id };
                                                                } else {
                                                                    next.push(newItem);
                                                                }
                                                            });
                                                            return next;
                                                        });
                                                        alert(`Success! Processed ${imported.length} BGEs. Data updated for matches.`);
                                                    } else {
                                                        alert('No matching data found. Please ensure your sheet has headings like Name, Location, and Code.');
                                                    }
                                                }}
                                            />
                                            <CSVImportButton
                                                onImport={(data) => {
                                                    const imported = data.map((item, i) => {
                                                        const name = item.name || item.bgename || item.fullname || item.expertname || item.Name || item.BGE_Name || item['BGE Name'];
                                                        const location = item.location || item.city || item.region || item.Location || item.Region || item.District;
                                                        const code = item.code || item.bgecode || item.expertid || item.Code || item.BGE_Code || item.ID;
                                                        const email = item.email || item.expertemail || item.bgeemail || item.Email || item['Email Address'] || '';
                                                        const specialisation = item.specialisation || item.specialization || item.skills || item.areaofspecialisation || item.areaofspecialization || item.Specialisation || item.Specialization || '';

                                                        return {
                                                            id: 'b' + Date.now() + i,
                                                            name: name || 'Unnamed BGE',
                                                            location: location || 'Unknown',
                                                            code: code || ('BGE-' + i),
                                                            email,
                                                            specialisation
                                                        };
                                                    }).filter(b => b.name && b.name !== 'Unnamed BGE');

                                                    if (imported.length > 0) {
                                                        setBges(prev => {
                                                            const next = [...prev];
                                                            imported.forEach(newItem => {
                                                                const index = next.findIndex(b =>
                                                                    (newItem.code && b.code === newItem.code) ||
                                                                    (b.name.toLowerCase() === newItem.name.toLowerCase())
                                                                );
                                                                if (index > -1) {
                                                                    next[index] = { ...next[index], ...newItem, id: next[index].id };
                                                                } else {
                                                                    next.push(newItem);
                                                                }
                                                            });
                                                            return next;
                                                        });
                                                        alert(`Success! Imported ${imported.length} BGEs. Data updated for matches.`);
                                                    } else {
                                                        alert('No matching data found. Please ensure your CSV has headings like Name, Location, and Code.');
                                                    }
                                                }}
                                                type="BGE"
                                            />
                                        </div>
                                    </div>

                                    <BgeTable
                                        bges={filteredBges}
                                        onDelete={deleteBge}
                                        editingBge={editingBge}
                                        setEditingBge={setEditingBge}
                                        handleSort={handleSort}
                                        bgeSort={bgeSort}
                                        onUpdate={(id, updates) => {
                                            setBges(bges.map(b => b.id === id ? { ...b, ...updates } : b));
                                            setEditingBge(null);
                                        }}
                                    />
                                </div>
                            )}

                            {activeTab === 'msmes' && (
                                <div className="space-y-6">
                                    <div className="flex flex-col gap-4 xl:flex-row xl:items-center xl:justify-between mb-6">
                                        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:gap-4 min-w-0">
                                            <div className="flex bg-gray-100 p-1 rounded-2xl w-fit">
                                                <button
                                                    onClick={() => setSelectedCohort('1')}
                                                    className={`px-4 py-2 rounded-2xl text-sm font-bold transition-all ${selectedCohort === '1' ? 'bg-white shadow text-gizblue-600' : 'text-gray-500 hover:text-gray-700'}`}
                                                >
                                                    Cohort 1
                                                </button>
                                                <button
                                                    onClick={() => setSelectedCohort('2')}
                                                    className={`px-4 py-2 rounded-2xl text-sm font-bold transition-all ${selectedCohort === '2' ? 'bg-white shadow text-gizblue-600' : 'text-gray-500 hover:text-gray-700'}`}
                                                >
                                                    Cohort 2
                                                </button>
                                            </div>
                                            <div className="relative w-full sm:w-auto">
                                                <select
                                                    value={msmeLocationFilter}
                                                    onChange={(e) => setMsmeLocationFilter(e.target.value)}
                                                    className="bg-gray-50 border-none rounded-2xl text-xs font-bold text-gray-600 px-4 py-3 focus:ring-2 focus:ring-gizblue-500 appearance-none pr-10 w-full sm:w-[220px]"
                                                >
                                                    <option value="all">All Locations</option>
                                                    {uniqueLocations.map(loc => (
                                                        <option key={loc} value={loc}>{loc}</option>
                                                    ))}
                                                </select>
                                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                                    <ChevronDown className="h-4 w-4" />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex flex-col sm:flex-row flex-wrap 2xl:flex-nowrap items-stretch sm:items-center justify-start 2xl:justify-end gap-2 w-full xl:w-auto">
                                            <CSVExportButton
                                                data={msmes.filter(m => m.cohort === selectedCohort).map(m => ({
                                                    'Business name': m.name,
                                                    'district': m.district,
                                                    'town/city': m.townCity,
                                                    'business physical location': m.location,
                                                    'name of key contact person': m.contactPerson,
                                                    'business role': m.businessRole,
                                                    'Mobile phone numbers (of contact person)': m.mobile,
                                                    'Email Address of contact person': m.contactEmail,
                                                    'Business Email Address': m.businessEmail,
                                                    'Name of the main founder': m.founderName,
                                                    'sex of founder': m.founderSex
                                                }))}
                                                filename={`msme_cohort_${selectedCohort}`}
                                                type={`Cohort ${selectedCohort}`}
                                            />
                                            <SheetSyncButton
                                                type={`Cohort ${selectedCohort} Sheet`}
                                                urlStorageKey={`prudev_sheet_url_msmes_c${selectedCohort}`}
                                                defaultUrl={selectedCohort === '1' ? QUICK_LINKS.msmeCohort1Sheet : QUICK_LINKS.msmeCohort2Sheet}
                                                onImport={(data) => {
                                                    const imported = [];

                                                    data.forEach((item, i) => {
                                                        const name = item['Name'] || item['Business name'] || item['Business Name:'] || item['Name of enterprise'] || item.name || item.businessname || item.msmename || item.companyname || item.Name || item.Business_Name || '';

                                                        // Common Fields
                                                        const district = item.District || item.district || '';
                                                        const townCity = item['Town'] || item['Town/City'] || item.Town || item.town || item.City || item.city || '';
                                                        const businessEmail = item['Business Email Address'] || item['Business email address'] || item.businessemail || '';

                                                        // Cohort 1 Specifics
                                                        const ownerName = item['Name of Business Owner'] || item['Name of Business Owner:'] || '';
                                                        const ownerMobile = item['Business Owner Contacts'] || '';
                                                        const ownerSex = item['Sex'] || item.Sex || '';
                                                        const ownerEmail = item['Business Owners Email'] || item['Business Owners Email:'] || '';
                                                        const ownerAge = item['Business Owners Age'] || item['Business Owners Age:'] || '';
                                                        const education = item['Level of Education of the Business Owner'] || item['Level of Education of the Business Owner:'] || '';
                                                        const businessType = item['Type of Business'] || item['Type of Business:'] || '';
                                                        const businessMobile = item['Business Phone Number'] || item['Business Phone Number(s)'] || item['Business Phone Number(s):'] || '';

                                                        // Cohort 2 Specifics
                                                        const location = item['Physical location'] || item['Business physical location'] || item['Business physical location:'] || item.location || '';
                                                        const contactPerson = item['Name of contact person'] || item['Name of key contact person'] || item['Name of key contact person:'] || '';
                                                        const businessRole = item['Role of the contact person'] || item['Business role of the contact person'] || '';
                                                        const contactGender = item['Gender of Key contact person'] || '';
                                                        const mobile = item['Mobile phone numbers'] || item['Mobile phone numbers (of contact person)'] || item['Mobile phone numbers (of contact person):'] || '';
                                                        const contactEmail = item['Email Address of contact person'] || item['Email Address of contact person:'] || '';
                                                        const founderName = item['Name of the main founder'] || '';
                                                        const founderSex = item['Sex of founder'] || '';

                                                        if (!name) return;

                                                        imported.push({
                                                            id: 'm' + Date.now() + i,
                                                            name, district, townCity, businessEmail,
                                                            ownerName, ownerMobile, ownerSex, ownerEmail, ownerAge, education, businessType, businessMobile,
                                                            location, contactPerson, businessRole, contactGender, mobile, contactEmail, founderName, founderSex,
                                                            cohort: selectedCohort
                                                        });
                                                    });

                                                    if (imported.length > 0) {
                                                        setMsmes(prev => {
                                                            const next = [...prev];
                                                            imported.forEach(newItem => {
                                                                const index = next.findIndex(m =>
                                                                    m.name.toLowerCase() === newItem.name.toLowerCase()
                                                                );
                                                                if (index > -1) {
                                                                    next[index] = { ...next[index], ...newItem, id: next[index].id };
                                                                } else {
                                                                    next.push(newItem);
                                                                }
                                                            });
                                                            return next;
                                                        });
                                                        alert(`Success! Processed ${imported.length} MSMEs into Cohort ${selectedCohort}. Data updated for matching names.`);
                                                    } else {
                                                        alert('No matching data found. Please check your sheet headers.');
                                                    }
                                                }}
                                            />
                                            <CSVImportButton
                                                onImport={(data) => {
                                                    const imported = [];

                                                    data.forEach((item, i) => {
                                                        const name = item['Name'] || item['Business name'] || item['Business Name:'] || item['Name of enterprise'] || item.name || item.businessname || item.msmename || item.companyname || item.Name || item.Business_Name || '';

                                                        // Common Fields
                                                        const district = item.District || item.district || '';
                                                        const townCity = item['Town'] || item['Town/City'] || item.Town || item.town || item.City || item.city || '';
                                                        const businessEmail = item['Business Email Address'] || item['Business email address'] || item.businessemail || '';

                                                        // Cohort 1 Specifics
                                                        const ownerName = item['Name of Business Owner'] || item['Name of Business Owner:'] || '';
                                                        const ownerMobile = item['Business Owner Contacts'] || '';
                                                        const ownerSex = item['Sex'] || item.Sex || '';
                                                        const ownerEmail = item['Business Owners Email'] || item['Business Owners Email:'] || '';
                                                        const ownerAge = item['Business Owners Age'] || item['Business Owners Age:'] || '';
                                                        const education = item['Level of Education of the Business Owner'] || item['Level of Education of the Business Owner:'] || '';
                                                        const businessType = item['Type of Business'] || item['Type of Business:'] || '';
                                                        const businessMobile = item['Business Phone Number'] || item['Business Phone Number(s)'] || item['Business Phone Number(s):'] || '';

                                                        // Cohort 2 Specifics
                                                        const location = item['Physical location'] || item['Business physical location'] || item['Business physical location:'] || item.location || '';
                                                        const contactPerson = item['Name of contact person'] || item['Name of key contact person'] || item['Name of key contact person:'] || '';
                                                        const businessRole = item['Role of the contact person'] || item['Business role of the contact person'] || '';
                                                        const contactGender = item['Gender of Key contact person'] || '';
                                                        const mobile = item['Mobile phone numbers'] || item['Mobile phone numbers (of contact person)'] || item['Mobile phone numbers (of contact person):'] || '';
                                                        const contactEmail = item['Email Address of contact person'] || item['Email Address of contact person:'] || '';
                                                        const founderName = item['Name of the main founder'] || '';
                                                        const founderSex = item['Sex of founder'] || '';

                                                        if (!name) return;

                                                        imported.push({
                                                            id: 'm' + Date.now() + i,
                                                            name, district, townCity, businessEmail,
                                                            ownerName, ownerMobile, ownerSex, ownerEmail, ownerAge, education, businessType, businessMobile,
                                                            location, contactPerson, businessRole, contactGender, mobile, contactEmail, founderName, founderSex,
                                                            cohort: selectedCohort
                                                        });
                                                    });

                                                    if (imported.length > 0) {
                                                        setMsmes(prev => {
                                                            const next = [...prev];
                                                            imported.forEach(newItem => {
                                                                const index = next.findIndex(m =>
                                                                    m.name.toLowerCase() === newItem.name.toLowerCase()
                                                                );
                                                                if (index > -1) {
                                                                    next[index] = { ...next[index], ...newItem, id: next[index].id };
                                                                } else {
                                                                    next.push(newItem);
                                                                }
                                                            });
                                                            return next;
                                                        });
                                                        alert(`Success! Imported ${imported.length} MSMEs into Cohort ${selectedCohort}. Data updated for matching names.`);
                                                    } else {
                                                        alert('No matching data found. Please check your CSV headers.');
                                                    }
                                                }}
                                                type={`Cohort ${selectedCohort}`}
                                            />
                                            <div className="hidden md:block border-l border-gray-200 h-10 mx-2"></div>
                                            <button
                                                onClick={clearAllMsmes}
                                                className="flex items-center space-x-2 text-gray-400 hover:text-red-500 px-4 py-2 rounded-2xl text-sm font-bold transition-all"
                                                title="CAUTION: Erase all MSME data"
                                            >
                                                <Trash2 className="w-3.5 h-3.5" />
                                                <span>Clear Directory</span>
                                            </button>
                                        </div>
                                    </div>

                                    <MsmeTable
                                        msmes={filteredMsmes}
                                        onDelete={deleteMsme}
                                        editingMsme={editingMsme}
                                        setEditingMsme={setEditingMsme}
                                        handleSort={handleSort}
                                        msmeSort={msmeSort}
                                        cohort={selectedCohort}
                                        onUpdate={(id, updates) => {
                                            setMsmes(msmes.map(m => m.id === id ? { ...m, ...updates } : m));
                                            setEditingMsme(null);
                                        }}
                                    />
                                </div>
                            )}

                            {activeTab === 'assignments' && (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                        <div className="lg:col-span-1 border-r border-gray-100 pr-8">
                                            <h4 className="font-bold text-gray-800 mb-4">Create New Pairing</h4>
                                            <PairingForm
                                                bges={bges}
                                                msmes={msmes}
                                                assignments={assignments}
                                                onPair={addAssignment}
                                            />
                                        </div>
                                        <div className="lg:col-span-2">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="flex items-center space-x-3">
                                                    <h4 className="font-bold text-gray-800">Assignments by Expert ({filteredBges.length})</h4>
                                                    <button
                                                        onClick={selectAllBges}
                                                        className="text-[10px] font-bold uppercase tracking-widest text-gizblue-600 bg-gizblue-50 px-2 py-1 rounded-2xl hover:bg-gizblue-100 transition-colors"
                                                    >
                                                        {selectedBgeIds.length === bges.length ? 'Deselect All' : 'Select All'}
                                                    </button>
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        if (selectedBgeIds.length === 0) {
                                                            alert('Please select at least one BGE to export the matrix.');
                                                            return;
                                                        }
                                                        window.print();
                                                    }}
                                                    className={`flex items-center space-x-2 px-4 py-2 rounded-2xl text-sm font-bold transition-all shadow-md active:scale-95 ${selectedBgeIds.length > 0
                                                        ? 'bg-gizblue-600 text-white hover:bg-gizblue-700'
                                                        : 'bg-gray-100 text-gray-400 cursor-not-allowed shadow-none'
                                                        }`}
                                                >
                                                    <Printer className="w-4 h-4" />
                                                    <span>Export {selectedBgeIds.length > 0 ? `(${selectedBgeIds.length}) ` : ''}Matrix</span>
                                                </button>
                                            </div>
                                            <div className="bg-white rounded-3xl border border-gray-100 overflow-x-auto shadow-sm">
                                                <table className="w-full text-left border-collapse">
                                                    <thead>
                                                        <tr className="bg-gray-50 text-gray-500 text-[10px] uppercase tracking-widest border-b border-gray-100">
                                                            <th className="px-6 py-4 font-bold w-1/3">Business Growth Expert</th>
                                                            <th className="px-6 py-4 font-bold w-2/3">Assigned MSMEs</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-gray-50">
                                                        {filteredBges.map(bge => {
                                                            const bgeAssignments = assignments.filter(a => a.bgeId === bge.id);
                                                            return (
                                                                <tr key={bge.id} className="hover:bg-gizblue-50/20 transition-colors">
                                                                    <td className="px-6 py-6 align-top">
                                                                        <div className="space-y-1">
                                                                            <h5 className="font-bold text-gray-900 text-sm">{bge.name}</h5>
                                                                            <p className="text-[10px] text-gizblue-600 font-black tracking-widest uppercase">{bge.code}</p>
                                                                            <p className="text-[10px] text-gray-400 font-medium italic">{bge.specialisation || 'Generalist'}</p>
                                                                            <div className="mt-4 flex flex-col items-start gap-1">
                                                                                <div className="inline-flex items-center px-2 py-1 bg-gizblue-50 rounded-full">
                                                                                    <span className="text-[9px] font-bold text-gizblue-600 uppercase tracking-tighter mr-2">Load:</span>
                                                                                    <span className="text-[11px] font-black text-gizblue-700">{bgeAssignments.length}</span>
                                                                                </div>
                                                                                <BgeEmailButton bge={bge} assignments={bgeAssignments} msmes={msmes} />
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td className="px-6 py-6 align-top">
                                                                        {bgeAssignments.length > 0 ? (
                                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                                                {bgeAssignments.map(a => {
                                                                                    const msme = msmes.find(m => m.id === a.msmeId);
                                                                                    return (
                                                                                        <div key={a.id} className="bg-gray-50/50 p-3 rounded-2xl border border-gray-100/50 flex items-center justify-between group hover:border-gizblue-200 hover:bg-white transition-all shadow-sm hover:shadow-gizblue-100">
                                                                                            <div className="flex items-center space-x-3 overflow-hidden">
                                                                                                <div className="flex-shrink-0 p-2 bg-white rounded-2xl">
                                                                                                    <Building className="w-4 h-4 text-gizgreen-600" />
                                                                                                </div>
                                                                                                <div className="min-w-0">
                                                                                                    <p className="text-[11px] font-bold text-gray-900 truncate uppercase">{a.msmeName}</p>
                                                                                                    <p className="text-[9px] text-gray-400 font-medium">{msme?.townCity || 'N/A'}</p>
                                                                                                </div>
                                                                                            </div>
                                                                                            <div className="flex items-center">
                                                                                                <MsmeEmailButton msme={msme} bge={bge} />
                                                                                                <button
                                                                                                    onClick={() => deleteAssignment(a.id)}
                                                                                                    className="text-red-300 hover:text-gopared-600 p-1.5 opacity-0 group-hover:opacity-100 transition-all bg-white rounded-full shadow-sm"
                                                                                                    title="Remove Assignment"
                                                                                                >
                                                                                                    <Trash2 className="w-3 h-3" />
                                                                                                </button>
                                                                                            </div>
                                                                                        </div>
                                                                                    );
                                                                                })}
                                                                            </div>
                                                                        ) : (
                                                                            <div className="py-2 text-gray-400 text-xs italic">
                                                                                No assignments found for this expert.
                                                                            </div>
                                                                        )}
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                        {filteredBges.length === 0 && (
                                                            <tr>
                                                                <td colSpan="2" className="p-12 text-center text-gray-400 text-sm italic">
                                                                    No records matching your search.
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'leaderboard' && (
                                <div className="space-y-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <div className="flex bg-gray-100 p-1 rounded-2xl">
                                            <button
                                                onClick={() => setLeaderboardSort('reports')}
                                                className={`px-4 py-2 rounded-2xl text-xs font-bold transition-all ${leaderboardSort === 'reports' ? 'bg-white shadow text-gizblue-600' : 'text-gray-500 hover:text-gray-700'}`}
                                            >
                                                Rank by Completion
                                            </button>
                                            <button
                                                onClick={() => setLeaderboardSort('msmes')}
                                                className={`px-4 py-2 rounded-2xl text-xs font-bold transition-all ${leaderboardSort === 'msmes' ? 'bg-white shadow text-gizblue-600' : 'text-gray-500 hover:text-gray-700'}`}
                                            >
                                                Rank by Assignments
                                            </button>
                                        </div>
                                        <CSVExportButton
                                            data={bges.map(bge => ({
                                                Name: bge.name,
                                                Code: bge.code,
                                                Specialisation: bge.specialisation,
                                                ReportsCount: reports.filter(r => r.bgeName === bge.name).length,
                                                AssignmentsCount: assignments.filter(a => a.bgeId === bge.id).length
                                            })).sort((a, b) => b.ReportsCount - a.ReportsCount)}
                                            filename="bge_leaderboard"
                                            type="Leaderboard"
                                        />
                                    </div>
                                    <div className="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm">
                                        <table className="w-full text-left">
                                            <thead>
                                                <tr className="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider">
                                                    <th className="px-6 py-4 font-semibold">Rank</th>
                                                    <th className="px-6 py-4 font-semibold">BGE Name</th>
                                                    <th className="px-6 py-4 font-semibold">Specialisation</th>
                                                    <th className="px-6 py-4 font-semibold text-center">MSMEs Assigned</th>
                                                    <th className="px-6 py-4 font-semibold text-center">Reports Completed</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-50">
                                                {filteredBges.map(bge => ({
                                                    ...bge,
                                                    msmeCount: assignments.filter(a => a.bgeId === bge.id).length,
                                                    reportCount: reports.filter(r => r.bgeName === bge.name).length
                                                }))
                                                    .sort((a, b) => leaderboardSort === 'reports' ? b.reportCount - a.reportCount : b.msmeCount - a.msmeCount)
                                                    .map((bge, index) => (
                                                        <tr key={bge.id} className="hover:bg-gizblue-50/30 transition-colors">
                                                            <td className="px-6 py-4">
                                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${index === 0 ? 'bg-gizblue-100 text-gizblue-700' :
                                                                    index === 1 ? 'bg-gray-100 text-gray-700' :
                                                                        index === 2 ? 'bg-orange-100 text-orange-700' : 'bg-gray-50 text-gray-500'
                                                                    }`}>
                                                                    {index + 1}
                                                                </div>
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                <div className="font-bold text-gray-900">{bge.name}</div>
                                                                <div className="text-xs text-gray-500">{bge.code}</div>
                                                            </td>
                                                            <td className="px-6 py-4 text-sm text-gray-600">{bge.specialisation || '-'}</td>
                                                            <td className="px-6 py-4 text-center">
                                                                <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-bold ${leaderboardSort === 'msmes' ? 'bg-gizblue-600 text-white' : 'bg-gizgreen-50 text-gizgreen-600'}`}>
                                                                    {bge.msmeCount}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 text-center">
                                                                <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-bold ${leaderboardSort === 'reports' ? 'bg-gizblue-600 text-white' : 'bg-gizblue-50 text-gizblue-600'}`}>
                                                                    {bge.reportCount}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'archive' && (
                                <div className="space-y-6">
                                    <div className="flex justify-end mb-4">
                                        <CSVExportButton
                                            data={reports.map(({ id, ...rest }) => rest)}
                                            filename="visit_reports_archive"
                                            type="Reports"
                                        />
                                    </div>
                                    <div className="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm">
                                        <table className="w-full text-left">
                                            <thead>
                                                <tr className="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider">
                                                    <th className="px-6 py-4 font-semibold">Date</th>
                                                    <th className="px-6 py-4 font-semibold">BGE</th>
                                                    <th className="px-6 py-4 font-semibold">MSME</th>
                                                    <th className="px-6 py-4 font-semibold text-right">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-50">
                                                {filteredReports.map((report, index) => (
                                                    <tr key={report.id || index} className="hover:bg-gizblue-50/30 transition-colors">
                                                        <td className="px-6 py-4 text-sm text-gray-600">{report.date}</td>
                                                        <td className="px-6 py-4">
                                                            <div className="font-bold text-gray-900 text-sm">{report.bgeName}</div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="flex items-center space-x-2">
                                                                <span className="text-sm text-gray-700 font-medium">{report.businessName}</span>
                                                                {report.gpsCaptured && (
                                                                    <div title={`Verified: ${report.latitude}, ${report.longitude}`} className="p-1 bg-gizblue-50 text-gizblue-600 rounded-2xl">
                                                                        <MapPin className="w-3 h-3" />
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4 text-right">
                                                            <div className="flex justify-end space-x-2">
                                                                <button onClick={() => {
                                                                    alert('Detailed report view logic can be expanded here.');
                                                                }} className="p-2 text-gizblue-600 bg-gizblue-50 rounded-2xl">
                                                                    <FileText className="w-4 h-4" />
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        if (confirm('Delete this report?')) {
                                                                            setReports(prev => prev.filter((_, i) => i !== index));
                                                                        }
                                                                    }}
                                                                    className="p-2 text-red-400 hover:text-gopared-600 hover:bg-gopared-50 rounded-2xl transition-all"
                                                                >
                                                                    <Trash2 className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {reports.length === 0 && (
                                                    <tr>
                                                        <td colSpan="4" className="px-6 py-12 text-center text-gray-400 font-medium lowercase">
                                                            No reports archived yet. Use the Visit Report form to save your first report.
                                                        </td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'analysis' && (
                                <div className="space-y-8 animate-in fade-in duration-500">
                                    {/* Overview Stats */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                                            <h5 className="text-xs font-bold text-gray-400 uppercase mb-4">MSME Cohort Distribution</h5>
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-2xl font-black text-gizblue-600">{stats.cohort1}</p>
                                                    <p className="text-xs text-gray-500">Cohort 1</p>
                                                </div>
                                                <div className="h-10 w-px bg-gray-100"></div>
                                                <div>
                                                    <p className="text-2xl font-black text-gizgreen-600">{stats.cohort2}</p>
                                                    <p className="text-xs text-gray-500">Cohort 2</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                                            <h5 className="text-xs font-bold text-gray-400 uppercase mb-4">BGE Coverage</h5>
                                            <p className="text-2xl font-black text-gray-900">{[...new Set(bges.map(b => b.location))].length}</p>
                                            <p className="text-xs text-gray-500">Unique Locations</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                                            <h5 className="text-xs font-bold text-gray-400 uppercase mb-4">Expert Skills</h5>
                                            <p className="text-2xl font-black text-gray-900">{[...new Set(bges.map(b => b.specialisation).filter(Boolean))].length}</p>
                                            <p className="text-xs text-gray-500">Specialisations</p>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        {/* Visits by BGE */}
                                        <div className="bg-white p-8 rounded-3xl border border-gray-100 shadow-sm">
                                            <h4 className="font-bold text-gray-800 mb-6 flex items-center">
                                                <Trophy className="w-5 h-5 mr-3 text-gizblue-500" />
                                                Most Productive Experts
                                            </h4>
                                            <div className="space-y-4">
                                                {bges.map(bge => ({
                                                    name: bge.name,
                                                    count: reports.filter(r => r.bgeName === bge.name).length
                                                }))
                                                    .sort((a, b) => b.count - a.count)
                                                    .slice(0, 5)
                                                    .map((item, idx) => (
                                                        <div key={item.name}>
                                                            <div className="flex justify-between text-sm mb-1">
                                                                <span className="font-bold text-gray-700">{item.name}</span>
                                                                <span className="text-gray-500 font-medium">{item.count} visits</span>
                                                            </div>
                                                            <div className="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                                                <div
                                                                    className={`h-2 rounded-full transition-all duration-1000 ${idx === 0 ? 'bg-gizblue-600' : 'bg-gizblue-400'}`}
                                                                    style={{ width: `${(item.count / (Math.max(...bges.map(b => reports.filter(r => r.bgeName === b.name).length), 1))) * 100}%` }}
                                                                ></div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                {reports.length === 0 && <p className="text-center text-gray-400 py-4 text-sm font-medium italic lowercase">No visit data available yet.</p>}
                                            </div>
                                        </div>

                                        {/* BGE Location Distribution */}
                                        <div className="bg-white p-8 rounded-3xl border border-gray-100 shadow-sm">
                                            <h4 className="font-bold text-gray-800 mb-6 flex items-center">
                                                <Building className="w-5 h-5 mr-3 text-gizblue-600" />
                                                BGE Network by Location
                                            </h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                {Object.entries(
                                                    bges.reduce((acc, b) => {
                                                        const loc = b.location || 'Unknown';
                                                        acc[loc] = (acc[loc] || 0) + 1;
                                                        return acc;
                                                    }, {})
                                                ).sort((a, b) => b[1] - a[1]).slice(0, 6).map(([loc, count]) => (
                                                    <div key={loc} className="p-3 bg-gray-50 rounded-2xl border border-gray-100">
                                                        <p className="text-xs font-bold text-gray-400 uppercase truncate" title={loc}>{loc}</p>
                                                        <p className="text-xl font-black text-gray-900">{count}</p>
                                                    </div>
                                                ))}
                                                {bges.length === 0 && <p className="col-span-2 text-center text-gray-400 py-4 text-sm italic lowercase">No BGE data available.</p>}
                                            </div>
                                        </div>

                                        {/* Specialisation Breakdown */}
                                        <div className="bg-white p-8 rounded-3xl border border-gray-100 shadow-sm">
                                            <h4 className="font-bold text-gray-800 mb-6 flex items-center">
                                                <Briefcase className="w-5 h-5 mr-3 text-gizgreen-600" />
                                                Specialisation Summary
                                            </h4>
                                            <div className="space-y-3">
                                                {Object.entries(
                                                    bges.reduce((acc, b) => {
                                                        if (b.specialisation) acc[b.specialisation] = (acc[b.specialisation] || 0) + 1;
                                                        return acc;
                                                    }, {})
                                                ).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([spec, count]) => (
                                                    <div key={spec} className="flex items-center justify-between text-sm">
                                                        <span className="text-gray-600 font-medium truncate pr-4">{spec}</span>
                                                        <span className="px-2 py-1 bg-gizgreen-50 text-gizgreen-600 rounded-lg font-bold min-w-[2rem] text-center">{count}</span>
                                                    </div>
                                                ))}
                                                {bges.filter(b => b.specialisation).length === 0 && (
                                                    <p className="text-center text-gray-400 italic text-sm py-8 lowercase">No specialisations documented yet.</p>
                                                )}
                                            </div>
                                        </div>

                                        {/* SWOT & System Insights */}
                                        <div className="bg-gizblue-600 p-8 rounded-3xl text-white relative overflow-hidden group">
                                            <Star className="absolute -right-4 -top-4 w-32 h-32 opacity-10 group-hover:scale-110 transition-transform duration-500" />
                                            <h4 className="font-bold mb-6 flex items-center">
                                                <Layout className="w-5 h-5 mr-3" />
                                                System Integration
                                            </h4>
                                            <p className="text-sm text-gizblue-100 leading-relaxed mb-6">
                                                The MSME Support Portal is managing <strong>{reports.length}</strong> archived reports across <strong>{bges.length}</strong> active experts. These data insights are used to optimize Work Package II outcomes.
                                            </p>
                                            <div className="bg-white/10 p-6 rounded-2xl border border-white/20">
                                                <div className="text-xs font-bold uppercase tracking-widest text-gizblue-200 mb-2">Most Recent Activity</div>
                                                {reports.length > 0 ? (
                                                    <p className="text-sm font-medium">"{reports[reports.length - 1].bgeName} submitted a visit report for {reports[reports.length - 1].businessName}"</p>
                                                ) : (
                                                    <p className="text-sm opacity-50 italic lowercase">Waiting for the first report submission...</p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Deployment Matrix Print View (Hidden on Screen) */}
                        <div className="hidden print:block p-10 bg-white min-h-screen">
                            <div className="max-w-4xl mx-auto">
                                {/* Header (Same as ReportForm) */}
                                <div className="mb-10 pb-8 border-b-2 border-gizblue">
                                    <div className="grid grid-cols-3 gap-4 items-center mb-8">
                                        <div className="flex justify-start">
                                            <img src="assets/giz_logo.png" alt="GIZ" className="h-16" />
                                        </div>
                                        <div className="text-center">
                                            <h1 className="text-3xl font-bold text-gray-900 font-serif leading-tight">PRUDEV II</h1>
                                            <p className="text-sm font-semibold text-gray-600 tracking-[0.2em] mt-1 uppercase">MSME Support Programme</p>
                                            <p className="text-xs font-bold text-gizblue mt-3 uppercase tracking-wider">Work package II: MSME Competitiveness</p>
                                        </div>
                                        <div className="flex justify-end">
                                            <img src="assets/gopa_afc_logo.png" alt="GOPA AFC" className="h-14" />
                                        </div>
                                    </div>
                                    <div className="text-center">
                                        <div className="inline-block px-8 py-2 border-2 border-gizblue rounded-lg">
                                            <h2 className="text-2xl font-black text-gizblue uppercase tracking-[0.3em]">Deployment Matrix</h2>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-0">
                                    <table className="w-full border-collapse border border-gray-300">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border border-gray-300 px-4 py-3 text-left w-1/3 text-xs font-bold uppercase">Business Growth Expert (BGE)</th>
                                                <th className="border border-gray-300 px-4 py-3 text-left w-2/3 text-xs font-bold uppercase">Assigned MSMEs & Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(selectedBgeIds.length > 0
                                                ? bges.filter(b => selectedBgeIds.includes(b.id))
                                                : bges
                                            ).map((bge, idx) => {
                                                const bgeAssignments = assignments.filter(a => a.bgeId === bge.id);
                                                return (
                                                    <tr key={bge.id} className="avoid-break">
                                                        <td className="border border-gray-300 p-4 align-top">
                                                            <p className="font-bold text-gray-900">{idx + 1}. {bge.name}</p>
                                                            <p className="text-[10px] text-gizblue font-black uppercase tracking-widest mt-1">{bge.code}</p>
                                                            <p className="text-[10px] text-gray-500 italic mt-1">{bge.specialisation || 'Generalist'}</p>
                                                            <div className="mt-4 pt-2 border-t border-gray-100">
                                                                <p className="text-[10px] text-gray-400 font-bold uppercase">Total Load</p>
                                                                <p className="text-lg font-black text-gizblue-600">{bgeAssignments.length}</p>
                                                            </div>
                                                        </td>
                                                        <td className="border border-gray-300 p-0 align-top">
                                                            {bgeAssignments.length > 0 ? (
                                                                <div className="divide-y divide-gray-200">
                                                                    {bgeAssignments.map(a => {
                                                                        const msme = msmes.find(m => m.id === a.msmeId);
                                                                        return (
                                                                            <div key={a.id} className="p-4 grid grid-cols-2 gap-x-6 gap-y-2">
                                                                                <div className="col-span-1">
                                                                                    <p className="text-xs font-black text-gray-900 uppercase">{a.msmeName}</p>
                                                                                    <p className="text-[10px] text-gray-500 font-bold">Cohort {msme?.cohort || '?'}</p>
                                                                                </div>
                                                                                <div className="col-span-1">
                                                                                    <p className="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Contact Person</p>
                                                                                    <p className="text-[10px] font-bold text-gray-700">{msme?.contactPerson || 'N/A'}</p>
                                                                                </div>
                                                                                <div className="col-span-1">
                                                                                    <p className="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Location</p>
                                                                                    <p className="text-[10px] font-bold text-gray-700">{msme?.townCity || msme?.location || 'N/A'}</p>
                                                                                    <p className="text-[9px] text-gray-500">{msme?.district || ''}</p>
                                                                                </div>
                                                                                <div className="col-span-1">
                                                                                    <p className="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Contact Info</p>
                                                                                    <p className="text-[10px] font-black text-gizblue-600">{msme?.mobile || 'No Phone'}</p>
                                                                                    <p className="text-[10px] italic text-gray-500">{msme?.businessRole || 'General'}</p>
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            ) : (
                                                                <p className="text-sm italic text-gray-400 p-4">No MSMEs assigned to this expert.</p>
                                                            )}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Footer */}
                                <div className="mt-20 pt-8 border-t border-gray-200 flex justify-between items-center text-[10px] text-gray-500 uppercase font-bold tracking-widest leading-none">
                                    <p>Official Deployment Matrix â€¢ PRUDEV II MSME Support Portal</p>
                                    <p>Extracted: {new Date().toLocaleDateString()} {new Date().toLocaleTimeString()}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Report Form Component
        const ReportForm = ({ formData, updateField, handlePrint, addReport, bges, msmes, assignments, reports }) => {
            const [isCapturing, setIsCapturing] = useState(false);
            const [activeFormTab, setActiveFormTab] = useState('new'); // 'new' or 'history'
            const [identifiedBge, setIdentifiedBge] = useState(() => localStorage.getItem('prudev_identified_bge') || '');

            useEffect(() => {
                if (identifiedBge) {
                    const bge = bges.find(b => b.name === identifiedBge);
                    if (bge) {
                        updateField('bgeName', bge.name);
                        updateField('bgeCode', bge.code);
                    }
                }
            }, [identifiedBge, bges]);

            const handleBgeIdentification = (name) => {
                setIdentifiedBge(name);
                if (name) {
                    localStorage.setItem('prudev_identified_bge', name);
                    const bge = bges.find(b => b.name === name);
                    if (bge) {
                        updateField('bgeName', bge.name);
                        updateField('bgeCode', bge.code);
                    }
                } else {
                    localStorage.removeItem('prudev_identified_bge');
                    updateField('bgeName', '');
                    updateField('bgeCode', '');
                }
            };

            const myReports = useMemo(() => {
                if (!identifiedBge) return [];
                return reports.filter(r => r.bgeName === identifiedBge).sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [reports, identifiedBge]);

            // Filter MSMEs based on current BGE selection
            const assignedMsmes = useMemo(() => {
                const currentBgeName = formData.bgeName || identifiedBge;
                if (!currentBgeName) return [];
                const bge = bges.find(b => b.name === currentBgeName);
                if (!bge) return [];

                const assignedIds = assignments
                    .filter(a => a.bgeId === bge.id)
                    .map(a => a.msmeId);

                return msmes.filter(m => assignedIds.includes(m.id));
            }, [formData.bgeName, identifiedBge, bges, msmes, assignments]);

            const captureLocation = () => {
                setIsCapturing(true);
                if (!navigator.geolocation) {
                    alert("Geolocation is not supported by your browser");
                    setIsCapturing(false);
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        updateField('latitude', latitude.toFixed(6));
                        updateField('longitude', longitude.toFixed(6));
                        updateField('gpsCaptured', true);
                        updateField('location', `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                        setIsCapturing(false);
                    },
                    (error) => {
                        alert("Unable to retrieve your location: " + error.message);
                        setIsCapturing(false);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            };

            return (
                <div className="space-y-6">
                    {/* Identification Section (Only if not identified) */}
                    {!identifiedBge && activeFormTab === 'new' && (
                        <div className="bg-gizblue-600 rounded-3xl p-6 sm:p-10 text-white shadow-xl shadow-gizblue-200 fade-in no-print">
                            <div className="max-w-2xl mx-auto text-center space-y-4">
                                <Users className="w-12 h-12 mx-auto opacity-80" />
                                <h2 className="text-2xl sm:text-3xl font-bold">Welcome, Expert</h2>
                                <p className="text-gizblue-50 text-sm sm:text-base opacity-90">Please identify yourself to begin creating reports and view your history.</p>
                                <div className="mt-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                                    <select
                                        value={identifiedBge}
                                        onChange={(e) => handleBgeIdentification(e.target.value)}
                                        className="flex-1 bg-white/10 border-2 border-white/20 rounded-2xl px-6 py-4 text-white font-bold focus:ring-0 focus:border-white appearance-none"
                                        style={{ colorScheme: 'dark' }}
                                    >
                                        <option value="" className="text-gray-900 font-bold">-- Select Your Name --</option>
                                        {bges.map(bge => (
                                            <option key={bge.id} value={bge.name} className="text-gray-900 font-bold">{bge.name}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>
                    )}

                    {identifiedBge && (
                        <div className="flex bg-gray-100 p-1 rounded-2xl w-fit mb-4 mx-auto no-print">
                            <button
                                onClick={() => setActiveFormTab('new')}
                                className={`px-4 sm:px-8 py-3 rounded-2xl text-xs sm:text-sm font-black uppercase tracking-widest transition-all ${activeFormTab === 'new' ? 'bg-white shadow text-gizblue-600' : 'text-gray-500'}`}
                            >
                                Create New Report
                            </button>
                            <button
                                onClick={() => setActiveFormTab('history')}
                                className={`px-4 sm:px-8 py-3 rounded-2xl text-xs sm:text-sm font-black uppercase tracking-widest transition-all ${activeFormTab === 'history' ? 'bg-white shadow text-gizblue-600' : 'text-gray-500'}`}
                            >
                                My Submissions ({myReports.length})
                            </button>
                        </div>
                    )}

                    {activeFormTab === 'new' && identifiedBge && (
                        <div className="no-print bg-white rounded-3xl shadow-xl p-6 sm:p-8 border border-gray-100 fade-in">
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 space-y-4 sm:space-y-0">
                                <div>
                                    <h2 className="text-2xl font-black text-gray-900">Visit Report Form</h2>
                                    <div className="flex items-center mt-1">
                                        <span className="text-[10px] font-bold text-gizblue-600 uppercase tracking-widest">Signed in as: {identifiedBge}</span>
                                        <button
                                            onClick={() => handleBgeIdentification('')}
                                            className="ml-3 text-[10px] font-bold text-red-400 hover:text-red-600 underline"
                                        >
                                            Switch User
                                        </button>
                                    </div>
                                </div>
                                <div className="flex space-x-2 w-full sm:w-auto">
                                    <button
                                        onClick={() => addReport({ ...formData, bgeName: identifiedBge })}
                                        className="flex-1 bg-gizgreen-600 text-white px-6 py-4 rounded-2xl text-sm font-bold hover:bg-green-700 transition-all shadow-lg shadow-gizgreen-100 flex items-center justify-center space-x-2"
                                    >
                                        <Save className="w-5 h-5" />
                                        <span>Save</span>
                                    </button>
                                    <button
                                        onClick={handlePrint}
                                        className="bg-gizblue-600 text-white px-6 py-4 rounded-2xl text-sm font-bold hover:bg-gizblue-700 transition-all shadow-lg shadow-gizblue-200 flex items-center justify-center space-x-2"
                                    >
                                        <Printer className="w-5 h-5" />
                                        <span className="hidden sm:inline">Print Preview</span>
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 sm:gap-8">
                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Visit Date</label>
                                        <input
                                            type="date"
                                            value={formData.date}
                                            onChange={(e) => updateField('date', e.target.value)}
                                            className="w-full bg-gray-50 border-none rounded-2xl px-5 py-4 text-sm font-bold focus:ring-2 focus:ring-gizblue-500"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2 flex items-center justify-between">
                                            <span>Location Verification (GPS)</span>
                                            {formData.gpsCaptured && (
                                                <span className="text-[9px] font-black text-gizgreen-600 bg-gizgreen-50 px-2 py-0.5 rounded-full">VERIFIED</span>
                                            )}
                                        </label>
                                        <div className="relative">
                                            <input
                                                type="text"
                                                value={formData.location}
                                                readOnly
                                                className="w-full bg-gray-50 border-none rounded-2xl pl-5 pr-40 py-4 text-sm font-bold text-gray-600"
                                                placeholder="Capture presence..."
                                            />
                                            <button
                                                onClick={captureLocation}
                                                disabled={isCapturing}
                                                className={`absolute right-1.5 top-1.5 bottom-1.5 px-4 rounded-xl text-[10px] font-bold transition-all flex items-center space-x-2 ${formData.gpsCaptured
                                                    ? 'bg-gizblue-50 text-gizblue-600 hover:bg-gizblue-100'
                                                    : 'bg-gizblue-600 text-white hover:bg-gizblue-700 shadow-sm'
                                                    }`}
                                            >
                                                <MapPin className={`w-3.5 h-3.5 ${isCapturing ? 'animate-bounce' : ''}`} />
                                                <span>{isCapturing ? 'Locating...' : formData.gpsCaptured ? 'Update GPS' : 'Capture GPS'}</span>
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Select Business</label>
                                        <select
                                            value={formData.businessName}
                                            onChange={(e) => updateField('businessName', e.target.value)}
                                            className="w-full bg-gray-50 border-none rounded-2xl px-5 py-4 text-sm font-bold focus:ring-2 focus:ring-gizblue-500"
                                        >
                                            <option value="">-- Choose MSME --</option>
                                            {assignedMsmes.map(msme => (
                                                <option key={msme.id} value={msme.name}>{msme.name}</option>
                                            ))}
                                        </select>
                                        {formData.bgeName && assignedMsmes.length === 0 && (
                                            <p className="mt-2 text-[10px] text-orange-600 bg-orange-50 p-2 rounded-xl italic">No businesses currently assigned to you. Contact admin for assignments.</p>
                                        )}
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Visit Objectives</label>
                                        <textarea
                                            value={formData.objectives}
                                            onChange={(e) => updateField('objectives', e.target.value)}
                                            className="w-full bg-gray-50 border-none rounded-2xl px-5 py-4 text-sm font-medium focus:ring-2 focus:ring-gizblue-500 min-h-[120px]"
                                            placeholder="What were you aiming to achieve?"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Activities Undertaken</label>
                                        <textarea
                                            value={formData.activities}
                                            onChange={(e) => updateField('activities', e.target.value)}
                                            className="w-full bg-gray-50 border-none rounded-2xl px-5 py-4 text-sm font-medium focus:ring-2 focus:ring-gizblue-500 min-h-[120px]"
                                            placeholder="Details of the support provided..."
                                        />
                                    </div>
                                </div>

                                <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 pt-6 border-t border-gray-50">
                                    {/* Sustainability items */}
                                    {['swot', 'leadership', 'gender', 'waste', 'climate', 'bdsActions'].map((key) => {
                                        const labels = {
                                            swot: 'SWOT Analysis',
                                            leadership: 'Leadership',
                                            gender: 'Gender',
                                            waste: 'Waste Management',
                                            climate: 'Climate Adaptation',
                                            bdsActions: 'BDS Actions'
                                        };
                                        return (
                                            <div key={key}>
                                                <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">{labels[key]}</label>
                                                <textarea
                                                    value={formData[key]}
                                                    onChange={(e) => updateField(key, e.target.value)}
                                                    className="w-full bg-gray-50 border-none rounded-2xl px-5 py-4 text-sm font-medium focus:ring-2 focus:ring-gizblue-500 min-h-[100px]"
                                                    placeholder={`${labels[key]} details...`}
                                                />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {activeFormTab === 'history' && (
                        <div className="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100 fade-in no-print">
                            <div className="p-6 border-b border-gray-50 bg-gray-50/50">
                                <h3 className="text-lg font-black text-gray-900">My Saved Reports</h3>
                                <p className="text-xs text-gray-500">History of reports submitted by {identifiedBge}</p>
                            </div>
                            <div className="divide-y divide-gray-50 max-h-[600px] overflow-y-auto">
                                {myReports.length > 0 ? (
                                    myReports.map((report) => (
                                        <div key={report.id} className="p-6 hover:bg-gizblue-50/20 transition-colors flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                                            <div className="flex items-start space-x-4">
                                                <div className="p-3 bg-gizblue-50 rounded-2xl">
                                                    <Calendar className="w-5 h-5 text-gizblue-600" />
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-gray-900">{report.businessName}</h4>
                                                    <p className="text-xs text-gray-500">{report.date} â€¢ {report.location}</p>
                                                    <div className="mt-2 flex items-center space-x-2">
                                                        {report.gpsCaptured && (
                                                            <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[9px] font-black bg-gizgreen-50 text-gizgreen-600">
                                                                GPS VERIFIED
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    alert('Detailed historical view implementation can follow.');
                                                }}
                                                className="w-full sm:w-auto px-6 py-3 bg-white border border-gray-200 rounded-2xl text-xs font-bold text-gray-600 hover:border-gizblue-600 hover:text-gizblue-600 transition-all flex items-center justify-center space-x-2"
                                            >
                                                <FileText className="w-4 h-4" />
                                                <span>View Details</span>
                                            </button>
                                        </div>
                                    ))
                                ) : (
                                    <div className="p-20 text-center text-gray-400">
                                        <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <ClipboardList className="w-8 h-8 opacity-20" />
                                        </div>
                                        <p className="text-sm font-bold">No reports submitted yet.</p>
                                        <p className="text-xs opacity-60 mt-1">Submit your first report to see it here.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Print Preview */}
                    <div className="print-area bg-white rounded-2xl shadow-xl p-12 border border-gray-200">
                        <div className="max-w-4xl mx-auto">
                            {/* Header */}
                            <div className="mb-10 pb-8 border-b-2 border-gizblue">
                                <div className="grid grid-cols-3 gap-4 items-center mb-8">
                                    <div className="flex justify-start">
                                        <img
                                            src="assets/giz_logo.png"
                                            alt="GIZ Logo"
                                            className="h-16 object-contain"
                                        />
                                    </div>
                                    <div className="text-center">
                                        <h1 className="text-3xl font-bold text-gray-900 font-serif leading-tight">PRUDEV II</h1>
                                        <p className="text-sm font-semibold text-gray-600 tracking-[0.2em] mt-1 uppercase">MSME Support Programme</p>
                                        <p className="text-xs font-bold text-gizblue mt-3 uppercase tracking-wider">Work package II: MSME Competitiveness</p>
                                    </div>
                                    <div className="flex justify-end">
                                        <img
                                            src="assets/gopa_afc_logo.png"
                                            alt="GOPA AFC Logo"
                                            className="h-14 object-contain"
                                        />
                                    </div>
                                </div>
                                <div className="text-center">
                                    <div className="inline-block px-8 py-2 border-2 border-gizblue rounded-lg">
                                        <h2 className="text-2xl font-black text-gizblue uppercase tracking-[0.3em]">MSME Visit Report</h2>
                                    </div>
                                </div>
                            </div>

                            {/* Report Details */}
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 gap-6 bg-gray-50 p-6 rounded-lg">
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Date</p>
                                        <p className="text-lg font-semibold text-gray-900">{formData.date || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Location</p>
                                        <div className="flex items-center space-x-2">
                                            <p className="text-lg font-semibold text-gray-900">{formData.location || 'N/A'}</p>
                                            {formData.gpsCaptured && (
                                                <div className="bg-gizblue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase print:border print:border-gizblue-600 print:text-gizblue-600">
                                                    GPS Verified
                                                </div>
                                            )}
                                        </div>
                                        {formData.gpsCaptured && (
                                            <p className="text-[10px] text-gray-500 font-mono mt-0.5">
                                                LAT: {formData.latitude} | LONG: {formData.longitude}
                                            </p>
                                        )}
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">BGE Name</p>
                                        <p className="text-lg font-semibold text-gray-900">{formData.bgeName || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">BGE Code</p>
                                        <p className="text-lg font-semibold text-gray-900">{formData.bgeCode || 'N/A'}</p>
                                    </div>
                                    <div className="col-span-2">
                                        <p className="text-sm font-medium text-gray-600">Business Name</p>
                                        <p className="text-lg font-semibold text-gray-900">{formData.businessName || 'N/A'}</p>
                                    </div>
                                </div>

                                {formData.objectives && (
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900 mb-2 flex items-center">
                                            <div className="w-1 h-6 bg-gizblue-600 mr-3"></div>
                                            Objectives of the Visit
                                        </h3>
                                        <p className="text-gray-700 leading-relaxed pl-4">{formData.objectives}</p>
                                    </div>
                                )}

                                {formData.activities && (
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900 mb-2 flex items-center">
                                            <div className="w-1 h-6 bg-gizblue-600 mr-3"></div>
                                            Activities Undertaken
                                        </h3>
                                        <p className="text-gray-700 leading-relaxed pl-4">{formData.activities}</p>
                                    </div>
                                )}

                                {formData.swot && (
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900 mb-2 flex items-center">
                                            <div className="w-1 h-6 bg-gizblue-600 mr-3"></div>
                                            SWOT Analysis
                                        </h3>
                                        <p className="text-gray-700 leading-relaxed pl-4">{formData.swot}</p>
                                    </div>
                                )}

                                {formData.leadership && (
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900 mb-2 flex items-center">
                                            <div className="w-1 h-6 bg-gizblue-600 mr-3"></div>
                                            Leadership & Governance
                                        </h3>
                                        <p className="text-gray-700 leading-relaxed pl-4">{formData.leadership}</p>
                                    </div>
                                )}

                                {formData.gender && (
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900 mb-2 flex items-center">
                                            <div className="w-1 h-6 bg-gizblue-600 mr-3"></div>
                                            Gender Considerations
                                        </h3>
                                        <p className="text-gray-700 leading-relaxed pl-4">{formData.gender}</p>
                                    </div>
                                )}

                                {formData.waste && (
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900 mb-2 flex items-center">
                                            <div className="w-1 h-6 bg-gizblue-600 mr-3"></div>
                                            Waste Management
                                        </h3>
                                        <p className="text-gray-700 leading-relaxed pl-4">{formData.waste}</p>
                                    </div>
                                )}

                                {formData.climate && (
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900 mb-2 flex items-center">
                                            <div className="w-1 h-6 bg-gizblue-600 mr-3"></div>
                                            Climate Change Adaptation
                                        </h3>
                                        <p className="text-gray-700 leading-relaxed pl-4">{formData.climate}</p>
                                    </div>
                                )}

                                {formData.bdsActions && (
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900 mb-2 flex items-center">
                                            <div className="w-1 h-6 bg-gizblue-600 mr-3"></div>
                                            BDS Actions & Recommendations
                                        </h3>
                                        <p className="text-gray-700 leading-relaxed pl-4">{formData.bdsActions}</p>
                                    </div>
                                )}
                            </div>

                            {/* Footer */}
                            <div className="mt-12 pt-6 border-t border-gray-300 text-center text-sm text-gray-600">
                                <p>Generated on {new Date().toLocaleDateString()} â€¢ PRUDEV II MSME Support Portal</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>